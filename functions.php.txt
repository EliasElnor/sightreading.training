<?php
/**
 * Fonctions personnalis√©es pour le th√®me enfant PianoMode VF
 */

// Activation PianoMode Account System 

require_once get_stylesheet_directory() . '/Account/functions-account.php';


/**
 * PIANOMODE LISTEN & PLAY - INT√âGRATION FUNCTIONS.PHP
 */

// =====================================================
// INCLUSION DU NOUVEAU SYST√àME LISTEN & PLAY
// =====================================================

// Inclusion du fichier PHP principal (OBLIGATOIRE)
if (file_exists(get_stylesheet_directory() . '/Listen & Play page/listen-play-page.php')) {
    require_once get_stylesheet_directory() . '/Listen & Play page/listen-play-page.php';
} else {
    // Fallback si le fichier n'existe pas
    add_action('admin_notices', function() {
        echo '<div class="notice notice-error"><p>‚ùå Fichier Listen & Play page/listen-play-page.php non trouv√©!</p></div>';
    });
}

// =====================================================
// ASSETS CONDITIONNELS (S√âCURIT√â)
// =====================================================

function pianomode_listen_play_conditional_assets() {
    // Charger uniquement si le shortcode est pr√©sent OU sur la page Listen & Play
    $load_assets = false;
    
    // V√©rifier si on est sur une page avec le shortcode
    if (is_page() && has_shortcode(get_post()->post_content, 'pianomode_scores')) {
        $load_assets = true;
    }
    
    // V√©rifier si c'est la page Listen & Play
    if (is_page('listen-and-play') || is_page('listen-play')) {
        $load_assets = true;
    }
    
    // Charger pour les administrateurs (d√©veloppement)
    if (current_user_can('administrator')) {
        $load_assets = true;
    }
    
    if ($load_assets) {
        // CSS
        wp_enqueue_style(
            'pianomode-listen-play-css', 
            get_stylesheet_directory_uri() . '/Listen & Play page/listen-play.css',
            array(),
            filemtime(get_stylesheet_directory() . '/Listen & Play page/listen-play.css') // Version dynamique
        );
        
        // JavaScript
        wp_enqueue_script(
            'pianomode-listen-play-js', 
            get_stylesheet_directory_uri() . '/Listen & Play page/listen-play.js',
            array('jquery'),
            filemtime(get_stylesheet_directory() . '/Listen & Play page/listen-play.js'), // Version dynamique
            true
        );
        
        // Localisation AJAX
        wp_localize_script('pianomode-listen-play-js', 'pianomode_ajax', array(
            'ajax_url' => admin_url('admin-ajax.php'),
            'nonce' => wp_create_nonce('pianomode_filter_nonce'),
            'debug' => WP_DEBUG
        ));
    }
}
add_action('wp_enqueue_scripts', 'pianomode_listen_play_conditional_assets', 20);

// =====================================================
// V√âRIFICATION DE COMPATIBILIT√â
// =====================================================

function pianomode_listen_play_compatibility_check() {
    $errors = array();
    
    // V√©rifier les fichiers
    $required_files = array(
        get_stylesheet_directory() . '/Listen & Play page/listen-play-page.php' => 'PHP principal',
        get_stylesheet_directory() . '/Listen & Play page/listen-play.css' => 'CSS',
        get_stylesheet_directory() . '/Listen & Play page/listen-play.js' => 'JavaScript'
    );
    
    foreach ($required_files as $file => $description) {
        if (!file_exists($file)) {
            $errors[] = "‚ùå {$description} manquant : " . basename($file);
        }
    }
    
    // V√©rifier les post types
    if (!post_type_exists('score')) {
        $errors[] = "‚ùå Post type 'score' non trouv√©";
    }
    
    // V√©rifier les taxonomies
    $taxonomies = array('score_composer', 'score_style', 'score_level');
    foreach ($taxonomies as $taxonomy) {
        if (!taxonomy_exists($taxonomy)) {
            $errors[] = "‚ùå Taxonomie '{$taxonomy}' non trouv√©e";
        }
    }
    
    // Afficher les erreurs si admin
    if (!empty($errors) && current_user_can('administrator')) {
        add_action('admin_notices', function() use ($errors) {
            echo '<div class="notice notice-warning">';
            echo '<p><strong>üéπ PianoMode Listen & Play - V√©rifications :</strong></p>';
            echo '<ul>' . implode('', array_map(function($error) {
                return '<li>' . $error . '</li>';
            }, $errors)) . '</ul>';
            echo '</div>';
        });
    }
    
    return empty($errors);
}
add_action('admin_init', 'pianomode_listen_play_compatibility_check');

// =====================================================
// DEBUG MODE (D√âVELOPPEMENT UNIQUEMENT)
// =====================================================

if (WP_DEBUG && current_user_can('administrator')) {
    function pianomode_listen_play_debug_info() {
        add_action('wp_footer', function() {
            if (is_page() && has_shortcode(get_post()->post_content, 'pianomode_scores')) {
                echo '<!-- üéπ PianoMode Listen & Play Debug: Assets charg√©s -->';
            }
        });
    }
    add_action('init', 'pianomode_listen_play_debug_info');
}



// =====================================================
// 12. META BOXES POUR POSTS - MISE √Ä JOUR AVEC OPTIONS
// =====================================================

// Ajouter les meta boxes UNIQUEMENT sur posts
function pianomode_add_post_meta_boxes() {
    add_meta_box(
        'pianomode_post_settings',
        'üéπ PianoMode Post Options',
        'pianomode_post_settings_callback',
        'post',
        'normal',
        'high'
    );
}
add_action('add_meta_boxes', 'pianomode_add_post_meta_boxes');

// Callback pour la meta box - VERSION AVEC OPTIONS
function pianomode_post_settings_callback($post) {
    wp_nonce_field('pianomode_save_post_settings', 'pianomode_post_nonce');
    
    // R√©cup√©rer les valeurs existantes
    $enable_piano = get_post_meta($post->ID, '_pianomode_enable_piano', true);
    $enable_newsletter = get_post_meta($post->ID, '_pianomode_enable_newsletter', true);
    $custom_chords = get_post_meta($post->ID, '_pianomode_chords', true);
    $piano_notes = get_post_meta($post->ID, '_pianomode_notes', true);
    
    // Accords par d√©faut
    $default_chords = array(
        'C3,E3,G3' => 'C Major',
        'F3,A3,C4' => 'F Major', 
        'G3,B3,D4' => 'G Major',
        'A3,C4,E4' => 'A Minor',
        'D3,F3,A3' => 'D Minor',
        'E3,G3,B3' => 'E Minor'
    );
    
    $chords_to_display = $custom_chords ?: $default_chords;
    ?>
    
    <div class="pianomode-meta-box" style="padding: 20px; background: #f9f9f9; border-radius: 8px;">
        
        <h3 style="margin: 0 0 20px 0; color: #C59D3A; border-bottom: 2px solid #C59D3A; padding-bottom: 10px;">
            üéπ PianoMode Features Configuration
        </h3>
        
        <!-- Options d'activation -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
            
            <!-- Option Piano -->
            <div style="padding: 15px; background: white; border-radius: 6px; border: 1px solid #ddd;">
                <h4 style="margin: 0 0 10px 0; color: #333;">üéπ Interactive Piano</h4>
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" name="pianomode_enable_piano" value="1" <?php checked($enable_piano, '1'); ?> style="margin-right: 8px;">
                    <span>Enable interactive piano widget in sidebar</span>
                </label>
                <p style="margin: 8px 0 0 0; font-size: 12px; color: #666;">
                    Shows piano with chord presets mentioned in the article
                </p>
            </div>
            
            <!-- Option Newsletter -->
            <div style="padding: 15px; background: white; border-radius: 6px; border: 1px solid #ddd;">
                <h4 style="margin: 0 0 10px 0; color: #333;">üìß Newsletter Widget</h4>
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" name="pianomode_enable_newsletter" value="1" <?php checked($enable_newsletter, '1'); ?> style="margin-right: 8px;">
                    <span>Enable "Stay in Tune" newsletter signup</span>
                </label>
                <p style="margin: 8px 0 0 0; font-size: 12px; color: #666;">
                    Displays newsletter signup at the bottom of article content (full width)
                </p>
            </div>
            
        </div>

        <!-- Configuration Piano (seulement si activ√©) -->
        <div id="piano-config" style="display: <?php echo $enable_piano ? 'block' : 'none'; ?>; border-top: 1px solid #ddd; padding-top: 20px;">
            
            <h4 style="margin: 0 0 15px 0; color: #C59D3A;">Piano Configuration</h4>
            
            <!-- Description du piano -->
            <div style="margin-bottom: 20px;">
                <label for="pianomode_notes" style="display: block; font-weight: bold; margin-bottom: 5px;">
                    Piano Description:
                </label>
                <input 
                    type="text" 
                    id="pianomode_notes" 
                    name="pianomode_notes" 
                    value="<?php echo esc_attr($piano_notes); ?>" 
                    placeholder="Click the keys to hear the chord progressions mentioned in this article:"
                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                />
            </div>

            <!-- Accords personnalis√©s -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; font-weight: bold; margin-bottom: 8px;">
                    Custom Chords (up to 6):
                </label>
                
                <div id="pianomode-chords-container">
                    <?php 
                    $chord_index = 0;
                    foreach ($chords_to_display as $chord_notes => $chord_name) : 
                    ?>
                        <div class="chord-row" style="display: flex; gap: 8px; margin-bottom: 8px; align-items: center;">
                            <input 
                                type="text" 
                                name="pianomode_chord_name[]" 
                                value="<?php echo esc_attr($chord_name); ?>" 
                                placeholder="Chord Name"
                                style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 3px; font-size: 13px;"
                            />
                            <input 
                                type="text" 
                                name="pianomode_chord_notes[]" 
                                value="<?php echo esc_attr($chord_notes); ?>" 
                                placeholder="Notes (ex: C3,E3,G3)"
                                style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 3px; font-size: 13px;"
                            />
                            <button type="button" class="remove-chord" style="background: #dc3545; color: white; border: none; padding: 6px 8px; border-radius: 3px; cursor: pointer; font-size: 12px;">‚úï</button>
                        </div>
                    <?php 
                    $chord_index++;
                    endforeach; 
                    
                    // Ajouter des lignes vides si moins de 6 accords
                    while ($chord_index < 6) :
                    ?>
                        <div class="chord-row" style="display: flex; gap: 8px; margin-bottom: 8px; align-items: center;">
                            <input 
                                type="text" 
                                name="pianomode_chord_name[]" 
                                value="" 
                                placeholder="Chord Name"
                                style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 3px; font-size: 13px;"
                            />
                            <input 
                                type="text" 
                                name="pianomode_chord_notes[]" 
                                value="" 
                                placeholder="Notes (ex: C3,E3,G3)"
                                style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 3px; font-size: 13px;"
                            />
                            <button type="button" class="remove-chord" style="background: #dc3545; color: white; border: none; padding: 6px 8px; border-radius: 3px; cursor: pointer; font-size: 12px;">‚úï</button>
                        </div>
                    <?php 
                    $chord_index++;
                    endwhile; 
                    ?>
                </div>
                
                <p style="margin: 8px 0 0 0; color: #666; font-size: 12px;">
                    <strong>Format:</strong> C3,E3,G3 (notes separated by commas)
                </p>
            </div>

            <!-- Bouton reset -->
            <button type="button" id="reset-to-default" style="background: #C59D3A; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 13px;">
                Reset to Default Chords
            </button>
            
        </div>
    </div>

    <script>
    jQuery(document).ready(function($) {
        // Afficher/masquer la config piano
        $('input[name="pianomode_enable_piano"]').change(function() {
            if ($(this).is(':checked')) {
                $('#piano-config').fadeIn();
            } else {
                $('#piano-config').fadeOut();
            }
        });
        
        // Supprimer une ligne d'accord
        $(document).on('click', '.remove-chord', function() {
            const row = $(this).closest('.chord-row');
            row.find('input[name="pianomode_chord_name[]"]').val('');
            row.find('input[name="pianomode_chord_notes[]"]').val('');
        });

        // Reset aux accords par d√©faut
        $('#reset-to-default').click(function() {
            const defaultChords = [
                {name: 'C Major', notes: 'C3,E3,G3'},
                {name: 'F Major', notes: 'F3,A3,C4'},
                {name: 'G Major', notes: 'G3,B3,D4'},
                {name: 'A Minor', notes: 'A3,C4,E4'},
                {name: 'D Minor', notes: 'D3,F3,A3'},
                {name: 'E Minor', notes: 'E3,G3,B3'}
            ];

            $('.chord-row').each(function(index) {
                const nameInput = $(this).find('input[name="pianomode_chord_name[]"]');
                const notesInput = $(this).find('input[name="pianomode_chord_notes[]"]');
                
                if (index < defaultChords.length) {
                    nameInput.val(defaultChords[index].name);
                    notesInput.val(defaultChords[index].notes);
                } else {
                    nameInput.val('');
                    notesInput.val('');
                }
            });
        });
    });
    </script>

    <?php
}

// Sauvegarder les meta donn√©es - VERSION MISE √Ä JOUR
function pianomode_save_post_settings($post_id) {
    // V√©rifications de s√©curit√©
    if (!isset($_POST['pianomode_post_nonce']) || 
        !wp_verify_nonce($_POST['pianomode_post_nonce'], 'pianomode_save_post_settings')) {
        return;
    }

    if (defined('DOING_AUTOSAVE') && DOING_AUTOSAVE) {
        return;
    }

    if (!current_user_can('edit_post', $post_id)) {
        return;
    }

    // Sauvegarder les options d'activation
    $enable_piano = isset($_POST['pianomode_enable_piano']) ? '1' : '0';
    $enable_newsletter = isset($_POST['pianomode_enable_newsletter']) ? '1' : '0';
    
    update_post_meta($post_id, '_pianomode_enable_piano', $enable_piano);
    update_post_meta($post_id, '_pianomode_enable_newsletter', $enable_newsletter);

    // Sauvegarder la description du piano
    if (isset($_POST['pianomode_notes'])) {
        update_post_meta($post_id, '_pianomode_notes', sanitize_text_field($_POST['pianomode_notes']));
    }

    // Sauvegarder les accords seulement si le piano est activ√©
    if ($enable_piano === '1' && isset($_POST['pianomode_chord_name']) && isset($_POST['pianomode_chord_notes'])) {
        $chord_names = $_POST['pianomode_chord_name'];
        $chord_notes = $_POST['pianomode_chord_notes'];
        $custom_chords = array();

        for ($i = 0; $i < count($chord_names); $i++) {
            $name = sanitize_text_field($chord_names[$i]);
            $notes = sanitize_text_field($chord_notes[$i]);
            
            // Valider le format des notes
            if (!empty($name) && !empty($notes) && preg_match('/^[A-G#0-9,]+$/', $notes)) {
                $custom_chords[$notes] = $name;
            }
        }

        if (!empty($custom_chords)) {
            update_post_meta($post_id, '_pianomode_chords', $custom_chords);
        } else {
            delete_post_meta($post_id, '_pianomode_chords');
        }
    }
}
add_action('save_post', 'pianomode_save_post_settings');


// =====================================================
// 12. ENREGISTREMENT DES ASSETS POST - CORRIG√â
// =====================================================

function pianomode_enqueue_post_assets() {
    // UNIQUEMENT sur les pages d'articles individuels
    if (is_single() && get_post_type() === 'post') {
        
        // CSS Post
        wp_enqueue_style(
            'pianomode-post-styles',
            get_stylesheet_directory_uri() . '/Explore page/pianomode-post-styles.css',
            array(),
            '1.1.0'
        );

        // JavaScript Post
        wp_enqueue_script(
            'pianomode-post-scripts',
            get_stylesheet_directory_uri() . '/Explore page/pianomode-post-scripts.js',
            array('jquery'),
            '1.1.0',
            true
        );

        // Variables pour le JavaScript
        wp_localize_script('Exlore page/pianomode-post-scripts', 'pianoModePost', array(
            'ajaxUrl' => admin_url('admin-ajax.php'),
            'nonce' => wp_create_nonce('pianomode_post_nonce'),
            'listenPlayUrl' => home_url('/listen-and-play'),
            'exploreUrl' => home_url('/explore'),
            'postId' => get_the_ID(),
            'category' => get_the_category() ? get_the_category()[0]->slug : 'general',
            'enablePiano' => get_post_meta(get_the_ID(), '_pianomode_enable_piano', true),
            'enableNewsletter' => get_post_meta(get_the_ID(), '_pianomode_enable_newsletter', true)
        ));
    }
}
add_action('wp_enqueue_scripts', 'pianomode_enqueue_post_assets');

// =====================================================
// 13. FONCTION CALCUL TEMPS DE LECTURE - SAFE
// =====================================================

if (!function_exists('pianomode_calculate_reading_time')) {
    function pianomode_calculate_reading_time($content) {
        // Nettoyer le contenu
        $clean_content = strip_tags($content);
        $clean_content = preg_replace('/\s+/', ' ', $clean_content);
        
        // Compter les mots
        $word_count = str_word_count(trim($clean_content));
        
        // Calculer le temps (200 mots/minute)
        $reading_time = ceil($word_count / 200);
        
        return max(1, $reading_time) . ' min read';
    }
}

// =====================================================
// 14. SHORTCODE POUR CONTENU EXISTANT
// =====================================================

function pianomode_piano_shortcode($atts) {
    $atts = shortcode_atts(array(
        'chords' => 'C3,E3,G3:C Major|F3,A3,C4:F Major|G3,B3,D4:G Major',
        'description' => 'Try these chords:'
    ), $atts);
    
    // Parser les accords
    $chord_pairs = explode('|', $atts['chords']);
    $chords_data = array();
    
    foreach ($chord_pairs as $pair) {
        $parts = explode(':', $pair);
        if (count($parts) === 2) {
            $chords_data[trim($parts[0])] = trim($parts[1]);
        }
    }
    
    ob_start();
    ?>
    <div class="pianomode-shortcode-widget" style="margin: 2rem 0; padding: 1.5rem; background: #f8f9fa; border-radius: 12px; border: 2px solid #C59D3A;">
        <h4 style="margin: 0 0 1rem 0; color: #C59D3A;">üéπ <?php echo esc_html($atts['description']); ?></h4>
        
        <div class="shortcode-chord-buttons" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
            <?php foreach ($chords_data as $notes => $name) : ?>
                <button class="shortcode-chord-btn" data-chord="<?php echo esc_attr($notes); ?>" 
                        style="background: #C59D3A; color: white; border: none; padding: 0.5rem 1rem; border-radius: 20px; cursor: pointer; font-size: 0.8rem;">
                    <?php echo esc_html($name); ?>
                </button>
            <?php endforeach; ?>
        </div>
        
        <p style="margin: 1rem 0 0 0; font-size: 0.8rem; color: #666;">
            Click the chord buttons to highlight the notes!
        </p>
    </div>
    <?php
    return ob_get_clean();
}
add_shortcode('pianomode_piano', 'pianomode_piano_shortcode');




// =====================================================
// META BOXES POUR SCORES - √Ä AJOUTER DANS FUNCTIONS.PHP
// =====================================================

// Ajouter les meta boxes pour les scores
function pianomode_add_score_meta_boxes() {
    add_meta_box(
        'pianomode_score_settings',
        'üéº PianoMode Score Settings',
        'pianomode_score_settings_callback',
        'score',
        'normal',
        'high'
    );
}
add_action('add_meta_boxes', 'pianomode_add_score_meta_boxes');

// Callback pour la meta box des scores
function pianomode_score_settings_callback($post) {
    wp_nonce_field('pianomode_save_score_settings', 'pianomode_score_nonce');
    
    // R√©cup√©rer les valeurs existantes
    $pdf_standard = get_post_meta($post->ID, '_score_pdf_standard', true);
    $pdf_classic = get_post_meta($post->ID, '_score_pdf_classic', true);
    $youtube_video = get_post_meta($post->ID, '_score_youtube_video', true);
    $playing_difficulty = get_post_meta($post->ID, '_score_playing_difficulty', true);
    $playing_tips = get_post_meta($post->ID, '_score_playing_tips', true);
    $score_notes = get_post_meta($post->ID, '_score_notes', true);
    
    // Options PianoMode (m√™me syst√®me que les posts)
    $enable_piano = get_post_meta($post->ID, '_pianomode_enable_piano', true);
    $enable_newsletter = get_post_meta($post->ID, '_pianomode_enable_newsletter', true);
    $custom_chords = get_post_meta($post->ID, '_pianomode_chords', true);
    $piano_notes = get_post_meta($post->ID, '_pianomode_notes', true);
    
    // Accords par d√©faut
    $default_chords = array(
        'C3,E3,G3' => 'C Major',
        'F3,A3,C4' => 'F Major', 
        'G3,B3,D4' => 'G Major',
        'A3,C4,E4' => 'A Minor',
        'D3,F3,A3' => 'D Minor',
        'E3,G3,B3' => 'E Minor'
    );
    
    $chords_to_display = $custom_chords ?: $default_chords;
    ?>
    
    <div class="pianomode-score-meta-box" style="padding: 20px; background: #f9f9f9; border-radius: 8px;">
        
        <h3 style="margin: 0 0 20px 0; color: #C59D3A; border-bottom: 2px solid #C59D3A; padding-bottom: 10px;">
            üéº Score Information & Files
        </h3>
        
        <!-- Fichiers PDF -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
            
            <!-- PDF Standard -->
            <div style="padding: 15px; background: white; border-radius: 6px; border: 1px solid #ddd;">
                <h4 style="margin: 0 0 10px 0; color: #333;">üìÑ Standard International Notation PDF</h4>
                <input type="url" 
                       name="score_pdf_standard" 
                       value="<?php echo esc_attr($pdf_standard); ?>" 
                       placeholder="https://example.com/sheet.pdf"
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 8px;" />
                <p style="margin: 0; font-size: 12px; color: #666;">
                    Direct link to the standard notation PDF
                </p>
            </div>
            
            <!-- PDF Classic -->
            <div style="padding: 15px; background: white; border-radius: 6px; border: 1px solid #ddd;">
                <h4 style="margin: 0 0 10px 0; color: #333;">üéº Classic Notation PDF</h4>
                <input type="url" 
                       name="score_pdf_classic" 
                       value="<?php echo esc_attr($pdf_classic); ?>" 
                       placeholder="https://example.com/classic-sheet.pdf"
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 8px;" />
                <p style="margin: 0; font-size: 12px; color: #666;">
                    Direct link to the classic notation PDF
                </p>
            </div>
            
        </div>
        
        <!-- Vid√©o et Niveau -->
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 30px;">
            
            <!-- YouTube Video -->
            <div style="padding: 15px; background: white; border-radius: 6px; border: 1px solid #ddd;">
                <h4 style="margin: 0 0 10px 0; color: #333;">üì∫ YouTube Video</h4>
                <input type="url" 
                       name="score_youtube_video" 
                       value="<?php echo esc_attr($youtube_video); ?>" 
                       placeholder="https://www.youtube.com/embed/VIDEO_ID"
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 8px;" />
                <p style="margin: 0; font-size: 12px; color: #666;">
                    YouTube embed URL (use embed format)
                </p>
            </div>
            
        </div>
        
        <!-- Notes et conseils -->
        <div style="margin-bottom: 30px;">
            
            <!-- Notes sur la partition -->
            <div style="margin-bottom: 20px;">
                <h4 style="margin: 0 0 10px 0; color: #333;">üìù Score Notes</h4>
                <textarea name="score_notes" 
                          rows="3" 
                          placeholder="General information about this score, its history, or special characteristics..."
                          style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; resize: vertical; font-family: Arial, sans-serif;"><?php echo esc_textarea($score_notes); ?></textarea>
            </div>
            
            <!-- Conseils de jeu -->
            <div style="margin-bottom: 20px;">
                <h4 style="margin: 0 0 10px 0; color: #333;">üéØ Playing Tips</h4>
                <textarea name="score_playing_tips" 
                          rows="3" 
                          placeholder="Specific tips for playing this piece (technique, fingering, tempo, etc.)..."
                          style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; resize: vertical; font-family: Arial, sans-serif;"><?php echo esc_textarea($playing_tips); ?></textarea>
            </div>
            
            <!-- Difficult√© -->
            <div>
                <h4 style="margin: 0 0 10px 0; color: #333;">‚ö° Playing Difficulty</h4>
                <textarea name="score_playing_difficulty" 
                          rows="2" 
                          placeholder="Description of the difficulty level and what makes this piece challenging..."
                          style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; resize: vertical; font-family: Arial, sans-serif;"><?php echo esc_textarea($playing_difficulty); ?></textarea>
            </div>
            
        </div>
        
        <!-- S√©parateur -->
        <div style="border-top: 2px solid #C59D3A; margin: 30px 0; padding-top: 20px;">
            <h3 style="margin: 0 0 20px 0; color: #C59D3A;">üéπ PianoMode Interactive Features</h3>
        </div>
        
        <!-- Options PianoMode -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
            
            <!-- Option Piano -->
            <div style="padding: 15px; background: white; border-radius: 6px; border: 1px solid #ddd;">
                <h4 style="margin: 0 0 10px 0; color: #333;">üéπ Interactive Piano</h4>
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" name="pianomode_enable_piano" value="1" <?php checked($enable_piano, '1'); ?> style="margin-right: 8px;">
                    <span>Enable interactive piano widget in sidebar</span>
                </label>
                <p style="margin: 8px 0 0 0; font-size: 12px; color: #666;">
                    Shows piano with chord presets for this score
                </p>
            </div>
            
            <!-- Option Newsletter -->
            <div style="padding: 15px; background: white; border-radius: 6px; border: 1px solid #ddd;">
                <h4 style="margin: 0 0 10px 0; color: #333;">üìß Newsletter Widget</h4>
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" name="pianomode_enable_newsletter" value="1" <?php checked($enable_newsletter, '1'); ?> style="margin-right: 8px;">
                    <span>Enable "Stay in Tune" newsletter signup</span>
                </label>
                <p style="margin: 8px 0 0 0; font-size: 12px; color: #666;">
                    Displays newsletter signup in the score content
                </p>
            </div>
            
        </div>

        <!-- Configuration Piano (seulement si activ√©) -->
        <div id="score-piano-config" style="display: <?php echo $enable_piano ? 'block' : 'none'; ?>; border-top: 1px solid #ddd; padding-top: 20px;">
            
            <h4 style="margin: 0 0 15px 0; color: #C59D3A;">Piano Configuration</h4>
            
            <!-- Description du piano -->
            <div style="margin-bottom: 20px;">
                <label for="pianomode_score_notes" style="display: block; font-weight: bold; margin-bottom: 5px;">
                    Piano Description:
                </label>
                <input 
                    type="text" 
                    id="pianomode_score_notes" 
                    name="pianomode_notes" 
                    value="<?php echo esc_attr($piano_notes); ?>" 
                    placeholder="Click the keys to hear the chord progressions for this piece:"
                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                />
            </div>

            <!-- Accords personnalis√©s -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; font-weight: bold; margin-bottom: 8px;">
                    Custom Chords for this Score (up to 6):
                </label>
                
                <div id="score-chords-container">
                    <?php 
                    $chord_index = 0;
                    foreach ($chords_to_display as $chord_notes => $chord_name) : 
                    ?>
                        <div class="chord-row" style="display: flex; gap: 8px; margin-bottom: 8px; align-items: center;">
                            <input 
                                type="text" 
                                name="pianomode_chord_name[]" 
                                value="<?php echo esc_attr($chord_name); ?>" 
                                placeholder="Chord Name"
                                style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 3px; font-size: 13px;"
                            />
                            <input 
                                type="text" 
                                name="pianomode_chord_notes[]" 
                                value="<?php echo esc_attr($chord_notes); ?>" 
                                placeholder="Notes (ex: C3,E3,G3)"
                                style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 3px; font-size: 13px;"
                            />
                            <button type="button" class="remove-chord" style="background: #dc3545; color: white; border: none; padding: 6px 8px; border-radius: 3px; cursor: pointer; font-size: 12px;">‚úï</button>
                        </div>
                    <?php 
                    $chord_index++;
                    endforeach; 
                    
                    // Ajouter des lignes vides si moins de 6 accords
                    while ($chord_index < 6) :
                    ?>
                        <div class="chord-row" style="display: flex; gap: 8px; margin-bottom: 8px; align-items: center;">
                            <input 
                                type="text" 
                                name="pianomode_chord_name[]" 
                                value="" 
                                placeholder="Chord Name"
                                style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 3px; font-size: 13px;"
                            />
                            <input 
                                type="text" 
                                name="pianomode_chord_notes[]" 
                                value="" 
                                placeholder="Notes (ex: C3,E3,G3)"
                                style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 3px; font-size: 13px;"
                            />
                            <button type="button" class="remove-chord" style="background: #dc3545; color: white; border: none; padding: 6px 8px; border-radius: 3px; cursor: pointer; font-size: 12px;">‚úï</button>
                        </div>
                    <?php 
                    $chord_index++;
                    endwhile; 
                    ?>
                </div>
                
                <p style="margin: 8px 0 0 0; color: #666; font-size: 12px;">
                    <strong>Format:</strong> C3,E3,G3 (notes separated by commas). Leave empty if not needed.
                </p>
            </div>

            <!-- Bouton reset -->
            <button type="button" id="reset-score-chords" style="background: #C59D3A; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 13px;">
                Reset to Default Chords
            </button>
            
        </div>
    </div>

    <script>
    jQuery(document).ready(function($) {
        // Afficher/masquer la config piano pour scores
        $('input[name="pianomode_enable_piano"]').change(function() {
            if ($(this).is(':checked')) {
                $('#score-piano-config').fadeIn();
            } else {
                $('#score-piano-config').fadeOut();
            }
        });
        
        // Supprimer une ligne d'accord
        $(document).on('click', '.remove-chord', function() {
            const row = $(this).closest('.chord-row');
            row.find('input[name="pianomode_chord_name[]"]').val('');
            row.find('input[name="pianomode_chord_notes[]"]').val('');
        });

        // Reset aux accords par d√©faut pour scores
        $('#reset-score-chords').click(function() {
            const defaultChords = [
                {name: 'C Major', notes: 'C3,E3,G3'},
                {name: 'F Major', notes: 'F3,A3,C4'},
                {name: 'G Major', notes: 'G3,B3,D4'},
                {name: 'A Minor', notes: 'A3,C4,E4'},
                {name: 'D Minor', notes: 'D3,F3,A3'},
                {name: 'E Minor', notes: 'E3,G3,B3'}
            ];

            $('.chord-row').each(function(index) {
                const nameInput = $(this).find('input[name="pianomode_chord_name[]"]');
                const notesInput = $(this).find('input[name="pianomode_chord_notes[]"]');
                
                if (index < defaultChords.length) {
                    nameInput.val(defaultChords[index].name);
                    notesInput.val(defaultChords[index].notes);
                } else {
                    nameInput.val('');
                    notesInput.val('');
                }
            });
        });
    });
    </script>

    <?php
}

// Sauvegarder les meta donn√©es des scores
function pianomode_save_score_settings($post_id) {
    // V√©rifications de s√©curit√©
    if (!isset($_POST['pianomode_score_nonce']) || 
        !wp_verify_nonce($_POST['pianomode_score_nonce'], 'pianomode_save_score_settings')) {
        return;
    }

    if (defined('DOING_AUTOSAVE') && DOING_AUTOSAVE) {
        return;
    }

    if (!current_user_can('edit_post', $post_id)) {
        return;
    }

    // Sauvegarder les donn√©es sp√©cifiques aux scores
    $score_fields = [
        'score_pdf_standard',
        'score_pdf_classic', 
        'score_youtube_video',
        'score_minimum_grade',
        'score_playing_difficulty',
        'score_playing_tips',
        'score_notes'
    ];

    foreach ($score_fields as $field) {
        $meta_key = '_' . $field;
        if (isset($_POST[$field])) {
            if (in_array($field, ['score_playing_difficulty', 'score_playing_tips', 'score_notes'])) {
                // Pour les textarea
                update_post_meta($post_id, $meta_key, sanitize_textarea_field($_POST[$field]));
            } elseif (in_array($field, ['score_pdf_standard', 'score_pdf_classic', 'score_youtube_video'])) {
                // Pour les URLs
                update_post_meta($post_id, $meta_key, esc_url_raw($_POST[$field]));
            } else {
                // Pour les autres champs
                update_post_meta($post_id, $meta_key, sanitize_text_field($_POST[$field]));
            }
        }
    }

    // Sauvegarder les options PianoMode (m√™me logique que pour les posts)
    $enable_piano = isset($_POST['pianomode_enable_piano']) ? '1' : '0';
    $enable_newsletter = isset($_POST['pianomode_enable_newsletter']) ? '1' : '0';
    
    update_post_meta($post_id, '_pianomode_enable_piano', $enable_piano);
    update_post_meta($post_id, '_pianomode_enable_newsletter', $enable_newsletter);

    // Sauvegarder la description du piano
    if (isset($_POST['pianomode_notes'])) {
        update_post_meta($post_id, '_pianomode_notes', sanitize_text_field($_POST['pianomode_notes']));
    }

    // Sauvegarder les accords seulement si le piano est activ√©
    if ($enable_piano === '1' && isset($_POST['pianomode_chord_name']) && isset($_POST['pianomode_chord_notes'])) {
        $chord_names = $_POST['pianomode_chord_name'];
        $chord_notes = $_POST['pianomode_chord_notes'];
        $custom_chords = array();

        for ($i = 0; $i < count($chord_names); $i++) {
            $name = sanitize_text_field($chord_names[$i]);
            $notes = sanitize_text_field($chord_notes[$i]);
            
            // Valider le format des notes
            if (!empty($name) && !empty($notes) && preg_match('/^[A-G#0-9,]+$/', $notes)) {
                $custom_chords[$notes] = $name;
            }
        }

        if (!empty($custom_chords)) {
            update_post_meta($post_id, '_pianomode_chords', $custom_chords);
        } else {
            delete_post_meta($post_id, '_pianomode_chords');
        }
    }
}
add_action('save_post', 'pianomode_save_score_settings');

function pianomode_enqueue_score_assets() {
    // UNIQUEMENT sur les pages de scores individuels
    if (is_single() && get_post_type() === 'score') {
        
        // CSS Score (r√©utilise le CSS post mais sans le JS qui pose probl√®me)
        wp_enqueue_style(
            'pianomode-score-styles',
            get_stylesheet_directory_uri() . '/Explore page/pianomode-post-styles.css',
            array(),
            '1.2.0'
        );

        // JavaScript Score S√âPAR√â (sans le CTA manager qui pose probl√®me)
        wp_enqueue_script(
            'pianomode-score-scripts',
            get_stylesheet_directory_uri() . '/pianomode-score-scripts.js',
            array('jquery'),
            '1.0.0',
            true
        );

        // Variables pour le JavaScript Score
        wp_localize_script('pianomode-score-scripts', 'pianoModeScore', array(
            'ajaxUrl' => admin_url('admin-ajax.php'),
            'nonce' => wp_create_nonce('pianomode_score_nonce'),
            'postId' => get_the_ID(),
            'enablePiano' => get_post_meta(get_the_ID(), '_pianomode_enable_piano', true),
            'enableNewsletter' => get_post_meta(get_the_ID(), '_pianomode_enable_newsletter', true)
        ));
    }
}
add_action('wp_enqueue_scripts', 'pianomode_enqueue_score_assets');

function pianomode_fix_pagination() {
    global $wp_rewrite;
    
    // Forcer la r√©g√©n√©ration des r√®gles de r√©√©criture
    if (is_admin() && isset($_GET['page']) && $_GET['page'] === 'pianomode-fix-pagination') {
        flush_rewrite_rules();
        wp_redirect(admin_url('admin.php?page=pianomode-pagination-fixed'));
        exit;
    }
    
    // S'assurer que les permaliens sont corrects pour les cat√©gories
    add_filter('paginate_links', 'pianomode_fix_pagination_links');
}
add_action('init', 'pianomode_fix_pagination');

// Corriger les liens de pagination
function pianomode_fix_pagination_links($link) {
    // Remplacer les anciens slugs par les nouveaux dans les liens de pagination
    $link = str_replace('/scores/', '/listen-and-play/', $link);
    $link = str_replace('/category/', '/explore/', $link);
    $link = str_replace('/gear-tips/', '/piano-accessories-setup/', $link);
    $link = str_replace('/learning/', '/piano-learning-tutorials/', $link);
    $link = str_replace('/inspiration/', '/piano-inspiration-stories/', $link);
    
    return $link;
}



// =====================================================
// SYST√àME URLs PIANOMODE - RESTAURATION + FIX SOUS-CAT
// =====================================================

/**
 * 1. CONFIGURATION DE BASE
 */
function pianomode_setup_url_structure() {
    global $wp_rewrite;
    $wp_rewrite->category_base = 'explore';
    
    if (get_option('pianomode_permalink_version') != '5.0') {
        flush_rewrite_rules(false);
        update_option('pianomode_permalink_version', '5.0');
    }
}
add_action('init', 'pianomode_setup_url_structure', 1);

/**
 * 2. ENREGISTREMENT CPT SCORE
 */
function pianomode_register_score_post_type() {
    register_post_type('score', array(
        'public' => true,
        'label' => 'Scores',
        'show_in_rest' => true,
        'supports' => array('title', 'editor', 'thumbnail', 'excerpt'),
        'has_archive' => false,
        'rewrite' => array(
            'slug' => 'listen-and-play',
            'with_front' => false
        ),
        'menu_icon' => 'dashicons-format-audio'
    ));
}
add_action('init', 'pianomode_register_score_post_type', 5);

/**
 * 3. R√àGLES DE R√â√âCRITURE
 */
function pianomode_add_rewrite_rules() {
    
    // POSTS - 3 niveaux : /explore/parent/child/article/
    add_rewrite_rule(
        '^explore/([^/]+)/([^/]+)/([^/]+)/?$',
        'index.php?pianomode_post_slug=$matches[3]&pianomode_subcategory=$matches[2]&pianomode_parent_cat=$matches[1]',
        'top'
    );
    
    // POSTS - 2 niveaux OU sous-cat√©gorie : /explore/category/???/
    add_rewrite_rule(
        '^explore/([^/]+)/([^/]+)/?$',
        'index.php?pianomode_resolve=$matches[2]&pianomode_parent=$matches[1]',
        'top'
    );
    
    // PAGINATION sous-cat√©gories
    add_rewrite_rule(
        '^explore/([^/]+)/([^/]+)/page/?([0-9]{1,})/?$',
        'index.php?category_name=$matches[2]&paged=$matches[3]',
        'top'
    );
    
    // CAT√âGORIE principale
    add_rewrite_rule(
        '^explore/([^/]+)/?$',
        'index.php?category_name=$matches[1]',
        'top'
    );
    
    // PAGINATION cat√©gorie principale
    add_rewrite_rule(
        '^explore/([^/]+)/page/?([0-9]{1,})/?$',
        'index.php?category_name=$matches[1]&paged=$matches[2]',
        'top'
    );
    
    // SCORES
    add_rewrite_rule(
        '^listen-and-play/([^/]+)/?$',
        'index.php?score=$matches[1]',
        'top'
    );
    
    add_rewrite_rule(
        '^listen-and-play/composer/([^/]+)/?$',
        'index.php?score_composer=$matches[1]',
        'top'
    );
    
    add_rewrite_rule(
        '^listen-and-play/style/([^/]+)/?$',
        'index.php?score_style=$matches[1]',
        'top'
    );
    
    add_rewrite_rule(
        '^listen-and-play/level/([^/]+)/?$',
        'index.php?score_level=$matches[1]',
        'top'
    );
}
add_action('init', 'pianomode_add_rewrite_rules', 10);

/**
 * 4. QUERY VARS
 */
function pianomode_add_query_vars($vars) {
    $vars[] = 'score_search';
    $vars[] = 'score_level';
    $vars[] = 'score_style';
    $vars[] = 'score_composer';
    $vars[] = 'pianomode_post_slug';
    $vars[] = 'pianomode_subcategory';
    $vars[] = 'pianomode_parent_cat';
    $vars[] = 'pianomode_resolve';
    $vars[] = 'pianomode_parent';
    return $vars;
}
add_filter('query_vars', 'pianomode_add_query_vars');

/**
 * 5. R√âSOLUTION INTELLIGENTE
 */
function pianomode_resolve_routes($query) {
    if (is_admin() || !$query->is_main_query()) {
        return;
    }
    
    // Ne pas toucher aux scores
    if (!empty($query->query_vars['score']) || 
        !empty($query->query_vars['score_composer']) ||
        !empty($query->query_vars['score_style']) ||
        !empty($query->query_vars['score_level'])) {
        return;
    }
    
    // === R√âSOLUTION 3 NIVEAUX ===
    $post_slug = get_query_var('pianomode_post_slug');
    $subcategory = get_query_var('pianomode_subcategory');
    $parent_cat = get_query_var('pianomode_parent_cat');
    
    if (!empty($post_slug)) {
        $post = get_page_by_path($post_slug, OBJECT, 'post');
        
        if ($post && $post->post_status === 'publish') {
            $categories = get_the_category($post->ID);
            $valid = false;
            
            foreach ($categories as $cat) {
                if ($cat->slug === $subcategory) {
                    if ($cat->parent) {
                        $parent = get_category($cat->parent);
                        if ($parent && $parent->slug === $parent_cat) {
                            $valid = true;
                            break;
                        }
                    }
                }
            }
            
            if ($valid) {
                $query->set('p', $post->ID);
                $query->set('post_type', 'post');
                $query->set('name', $post->post_name);
                
                $query->set('pianomode_post_slug', '');
                $query->set('pianomode_subcategory', '');
                $query->set('pianomode_parent_cat', '');
                
                $query->is_single = true;
                $query->is_singular = true;
                $query->is_category = false;
                $query->is_archive = false;
                $query->is_home = false;
                $query->is_page = false;
                $query->is_search = false;
                $query->is_tag = false;
                $query->is_tax = false;
                $query->is_404 = false;
                
                $query->queried_object = $post;
                $query->queried_object_id = $post->ID;
                
                return;
            }
        }
        
        $query->set_404();
        return;
    }
    
    // === R√âSOLUTION 2 NIVEAUX AMBIGUS ===
    $resolve_slug = get_query_var('pianomode_resolve');
    $parent_slug = get_query_var('pianomode_parent');
    
    if (!empty($resolve_slug)) {
        // Essayer POST d'abord
        $post = get_page_by_path($resolve_slug, OBJECT, 'post');
        
        if ($post && $post->post_status === 'publish') {
            $categories = get_the_category($post->ID);
            
            foreach ($categories as $cat) {
                if ($cat->slug === $parent_slug || 
                    ($cat->parent && get_category($cat->parent)->slug === $parent_slug)) {
                    
                    $query->set('p', $post->ID);
                    $query->set('post_type', 'post');
                    $query->set('name', $post->post_name);
                    
                    $query->set('pianomode_resolve', '');
                    $query->set('pianomode_parent', '');
                    
                    $query->is_single = true;
                    $query->is_singular = true;
                    $query->is_category = false;
                    $query->is_archive = false;
                    $query->is_home = false;
                    $query->is_page = false;
                    $query->is_search = false;
                    $query->is_tag = false;
                    $query->is_tax = false;
                    $query->is_404 = false;
                    
                    $query->queried_object = $post;
                    $query->queried_object_id = $post->ID;
                    
                    return;
                }
            }
        }
        
        // Sinon CAT√âGORIE
        $category = get_category_by_slug($resolve_slug);
        
        if ($category) {
            $parent = $category->parent ? get_category($category->parent) : null;
            
            if ($parent && $parent->slug === $parent_slug) {
                $query->set('category_name', $resolve_slug);
                $query->set('cat', $category->term_id);
                
                $query->set('pianomode_resolve', '');
                $query->set('pianomode_parent', '');
                
                $query->is_category = true;
                $query->is_archive = true;
                $query->is_single = false;
                $query->is_singular = false;
                $query->is_home = false;
                $query->is_page = false;
                $query->is_404 = false;
                
                $query->queried_object = $category;
                $query->queried_object_id = $category->term_id;
                
                return;
            }
        }
        
        $query->set_404();
        return;
    }
}
add_action('parse_query', 'pianomode_resolve_routes', 5);

/**
 * 6. REDIRECTIONS 301 - AVEC FIX SOUS-CAT√âGORIES
 */
function pianomode_handle_redirects() {
    $uri = $_SERVER['REQUEST_URI'];
    
    // Anciennes URLs /category/ ‚Üí /explore/
    if (strpos($uri, '/category/') !== false) {
        wp_redirect(home_url(str_replace('/category/', '/explore/', $uri)), 301);
        exit;
    }
    
    // Anciennes URLs /scores/ ‚Üí /listen-and-play/
    if (strpos($uri, '/scores/') !== false) {
        wp_redirect(home_url(str_replace('/scores/', '/listen-and-play/', $uri)), 301);
        exit;
    }
    
    // NOUVEAU : Redirection sous-cat√©gories sans parent
    if (is_category()) {
        $category = get_queried_object();
        
        if ($category && $category->parent) {
            // C'est une sous-cat√©gorie
            $correct_url = pianomode_category_link('', $category->term_id, 'category');
            $current_url = home_url($uri);
            
            // Normaliser pour comparaison
            $correct_normalized = rtrim($correct_url, '/');
            $current_normalized = rtrim($current_url, '/');
            
            // Si pas la bonne URL (sans parent), rediriger
            if ($correct_normalized !== $current_normalized) {
                wp_redirect($correct_url, 301);
                exit;
            }
        }
    }
}
add_action('template_redirect', 'pianomode_handle_redirects', 1);

/**
 * 7. FORCER LE BON TEMPLATE
 */
function pianomode_force_correct_template($template) {
    global $wp_query;
    
    if ($wp_query->is_single && !$wp_query->is_page) {
        $post_type = get_post_type();
        
        if ($post_type === 'post') {
            $templates = array(
                'single-post.php',
                'single.php',
                'singular.php',
                'index.php'
            );
            
            foreach ($templates as $template_name) {
                $located = locate_template($template_name);
                if ($located) {
                    return $located;
                }
            }
        }
        
        if ($post_type === 'score') {
            $templates = array(
                'single-score.php',
                'single.php',
                'singular.php',
                'index.php'
            );
            
            foreach ($templates as $template_name) {
                $located = locate_template($template_name);
                if ($located) {
                    return $located;
                }
            }
        }
    }
    
    if ($wp_query->is_category) {
        $category = get_queried_object();
        
        $templates = array(
            'category-' . $category->slug . '.php',
            'category-' . $category->term_id . '.php',
            'category.php',
            'archive.php',
            'index.php'
        );
        
        foreach ($templates as $template_name) {
            $located = locate_template($template_name);
            if ($located) {
                return $located;
            }
        }
    }
    
    return $template;
}
add_filter('template_include', 'pianomode_force_correct_template', 999);

/**
 * 8. PERMALIENS POSTS
 */
function pianomode_post_permalink($permalink, $post) {
    if ($post->post_type !== 'post' || !is_object($post)) {
        return $permalink;
    }
    
    $categories = get_the_category($post->ID);
    if (empty($categories)) {
        return home_url('/explore/' . $post->post_name . '/');
    }
    
    $category = $categories[0];
    $hierarchy = array();
    
    while ($category) {
        array_unshift($hierarchy, $category->slug);
        $category = $category->parent ? get_category($category->parent) : null;
    }
    
    $path = implode('/', array_merge(array('explore'), $hierarchy, array($post->post_name)));
    return home_url($path . '/');
}
add_filter('post_link', 'pianomode_post_permalink', 10, 2);

/**
 * 9. PERMALIENS CAT√âGORIES
 */
function pianomode_category_link($link, $term_id, $taxonomy) {
    if ($taxonomy !== 'category') {
        return $link;
    }
    
    $category = get_category($term_id);
    if (!$category) {
        return $link;
    }
    
    $hierarchy = array();
    
    while ($category) {
        array_unshift($hierarchy, $category->slug);
        $category = $category->parent ? get_category($category->parent) : null;
    }
    
    $path = implode('/', array_merge(array('explore'), $hierarchy));
    return home_url($path . '/');
}
add_filter('term_link', 'pianomode_category_link', 10, 3);

/**
 * 10. PERMALIENS SCORES
 */
function pianomode_score_permalink($permalink, $post) {
    if ($post->post_type !== 'score' || !is_object($post)) {
        return $permalink;
    }
    return home_url('/listen-and-play/' . $post->post_name . '/');
}
add_filter('post_type_link', 'pianomode_score_permalink', 10, 2);

/**
 * 11. BALISES CANONICAL (SEO)
 */
function pianomode_add_canonical() {
    remove_action('wp_head', 'rel_canonical');
    
    if (is_singular('post')) {
        global $post;
        $canonical = pianomode_post_permalink(get_permalink($post), $post);
        echo '<link rel="canonical" href="' . esc_url($canonical) . '" />' . "\n";
        
    } elseif (is_category()) {
        $term = get_queried_object();
        $canonical = pianomode_category_link('', $term->term_id, 'category');
        echo '<link rel="canonical" href="' . esc_url($canonical) . '" />' . "\n";
        
    } elseif (is_singular('score')) {
        global $post;
        $canonical = pianomode_score_permalink(get_permalink($post), $post);
        echo '<link rel="canonical" href="' . esc_url($canonical) . '" />' . "\n";
    }
}
add_action('wp_head', 'pianomode_add_canonical', 1);

/**
 * 12. SUPPORT SITEMAP XML
 */
function pianomode_sitemap_urls($url, $post) {
    if ($post->post_type === 'post') {
        return pianomode_post_permalink('', $post);
    } elseif ($post->post_type === 'score') {
        return pianomode_score_permalink('', $post);
    }
    return $url;
}
add_filter('wpseo_xml_sitemap_post_url', 'pianomode_sitemap_urls', 10, 2);
add_filter('rank_math/sitemap/entry', 'pianomode_sitemap_urls', 10, 2);

/**
 * 13. FLUSH AUTOMATIQUE
 */
function pianomode_auto_flush() {
    if (get_option('pianomode_urls_active') !== '5.0') {
        flush_rewrite_rules(false);
        update_option('pianomode_urls_active', '5.0');
    }
}
add_action('wp_loaded', 'pianomode_auto_flush', 999);




// PIANOMODE HEADER FOOTER - VERSION CORRIG√âE
function pianomode_complete_design() {
    // Detecter page accueil
    $is_home = is_front_page() || is_home();
    
    // URLs
    $logo_url = site_url('/wp-content/uploads/2025/05/Logo-def_NOIR.png');
    $video_url = site_url('/wp-content/uploads/2025/05/freepik-untitled-creation-2025-05-30.mp4');
    $mobile_bg = site_url('/wp-content/uploads/2025/05/Capture-decran-2025-05-31-164137.png');
    
    // CSS modifi√© avec les nouvelles demandes
    ?>
    <style>
    /* FONT LOADING OPTIMIS√â */
    @import url("https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;900&display=swap");
    
    :root {
        --gold-primary: #C59D3A;
        --gold-dark: #B8860B;
        --gold-light: rgba(197, 157, 58, 0.1);
        --gold-medium: rgba(197, 157, 58, 0.3);
        --gold-bright: #D4AF47;
        
        /* Nouvelles couleurs all√©g√©es */
        --white-pure: #ffffff;
        --white-soft: rgba(255, 255, 255, 0.95);
        --gray-light: rgba(255, 255, 255, 0.12);
        --gray-medium: rgba(255, 255, 255, 0.25);
        --black-soft: rgba(0, 0, 0, 0.6);
        --black-light: rgba(0, 0, 0, 0.3);
    }
    
    /* RESET OPTIMIS√â */
    * {
        box-sizing: border-box;
    }
    
    html, body {
        background: #fff;
        margin: 0;
        padding: 0;
    }
    
    /* MASQUER BLOCKSY */
    .site-header, #header, .ct-header,
    .site-footer, #footer, .ct-footer { 
        display: none !important; 
    }
    
    /* FIX SP√âCIFIQUE PAGE EXPLORE */
    body.page-id-1077 .entry-title,
    body.page-id-1077 .entry-header,
    body.page-id-1077 article > h1:first-child,
    body.page-id-1077 article > h2:first-child,
    .page-template-default.page-explore h1:not(.brand-text h1),
    .page-template-default.page-explore h2:not(.brand-text h1) {
        position: absolute !important;
        left: -99999px !important;
        top: -99999px !important;
        width: 1px !important;
        height: 1px !important;
    }
    
    /* FIX CRITIQUE : Correction du probl√®me de zone bloqu√©e par le header sticky */
    body:not(.home-page) { 
        padding-top: 0; /* Pas de padding-top */
    }
    body.home-page { 
        padding-top: 0; 
    }
    
    /* NOUVEAU : Hero positionn√© avec la nouvelle hauteur */
    .entry-content > *:first-child,
    .hero-section,
    .page-hero,
    .pianomode-hero-explore {
        padding-top: 100px !important; /* Comme avant */
        margin-top: -20px !important; /* Comme avant */
    }
    
    /* HEADER PRINCIPAL STABILIS√â */
    .piano-header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 99999;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        font-family: "Montserrat", sans-serif;
        width: 100%;
        height: 140px;
        pointer-events: none; /* Important: permet les clics √† travers */
    }
    
    /* Rendre les √©l√©ments interactifs cliquables */
    .piano-header * {
        pointer-events: auto;
    }
    
    /* TOP BAR AM√âLIOR√âE - PLUS FINE ET ANIM√âE */
    .top-bar {
        background: linear-gradient(45deg, 
            var(--gold-primary) 0%, 
            var(--gold-bright) 25%,
            var(--gold-dark) 50%,
            var(--gold-bright) 75%,
            var(--gold-primary) 100%);
        background-size: 300% 100%;
        padding: 8px 20px;
        text-align: center;
        font-size: 11px;
        font-weight: 700;
        letter-spacing: 3px;
        text-transform: uppercase;
        color: #fff;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        animation: gradientShift 8s ease-in-out infinite;
    }
    
    /* Animation du gradient de fond */
    @keyframes gradientShift {
        0%, 100% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
    }
    
    /* Particules dor√©es anim√©es */
    .top-bar::before {
        content: "‚ô™ ‚ô´ ‚ô™";
        position: absolute;
        top: 50%;
        left: -100%;
        transform: translateY(-50%);
        font-size: 14px;
        color: rgba(255, 255, 255, 0.6);
        animation: musicNotes 12s linear infinite;
        pointer-events: none;
    }
    
    /* Wave animation optimis√©e */
    .top-bar::after {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, 
            transparent, 
            rgba(255,255,255,0.25), 
            rgba(255,255,255,0.4),
            rgba(255,255,255,0.25),
            transparent);
        animation: waveFlow 6s linear infinite;
        will-change: transform;
    }
    
    @keyframes waveFlow {
        to { transform: translateX(200%); }
    }
    
    @keyframes musicNotes {
        to { transform: translateY(-50%) translateX(calc(100vw + 200px)); }
    }
    
    /* SCROLL STATE - TOP BAR DISPARAIT */
    .piano-header.scrolled .top-bar {
        transform: translateY(-32px);
        opacity: 0;
        pointer-events: none;
    }
    
    /* MAIN NAV - FULL WIDTH AVEC CONTENU CENTR√â */
    .main-nav {
        background: linear-gradient(to bottom, 
            rgba(60, 60, 60, 0.9) 0%,
            rgba(80, 80, 80, 0.7) 20%,
            rgba(120, 120, 120, 0.5) 40%,
            rgba(200, 200, 200, 0.3) 60%,
            rgba(255, 255, 255, 0.1) 75%,
            rgba(0, 0, 0, 0.15) 90%,
            rgba(0, 0, 0, 0.08) 100%);
        
        backdrop-filter: blur(25px) saturate(130%);
        -webkit-backdrop-filter: blur(25px) saturate(130%);
        
        width: 100% !important;
        height: 108px;
        padding: 0;
        
        display: flex;
        align-items: center;
        justify-content: center;
        
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        border: none;
        left: 0;
        right: 0;
    }
    
    /* Container interne pour le contenu centr√© */
    .main-nav .nav-content-wrapper {
        width: 100%;
        max-width: 1400px;
        padding: 0 60px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    /* HOME - HEADER TRANSPARENT FULL WIDTH */
    .home-page .main-nav {
        background: linear-gradient(to bottom, 
            rgba(40, 40, 40, 0.4) 0%,
            rgba(80, 80, 80, 0.3) 30%,
            rgba(150, 150, 150, 0.2) 50%,
            rgba(200, 200, 200, 0.1) 75%,
            rgba(0, 0, 0, 0.1) 90%,
            rgba(0, 0, 0, 0.05) 100%);
        border: none;
        width: 100% !important;
        height: 108px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    /* SCROLL STATE - HEADER COMPRESS√â FULL WIDTH */
    .piano-header.scrolled .main-nav {
        height: 80px;
        padding: 0;
        transform: translateY(-32px);
        background: linear-gradient(to bottom, 
            rgba(70, 70, 70, 0.9) 0%,
            rgba(120, 120, 120, 0.6) 30%,
            rgba(180, 180, 180, 0.3) 60%,
            rgba(255, 255, 255, 0.1) 80%,
            rgba(0, 0, 0, 0.05) 100%);
        border: none;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        width: 100% !important;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    /* LOGO SECTION STABILIS√âE */
    .logo-section {
        display: flex;
        align-items: center;
        gap: 18px;
        flex-shrink: 0;
        min-height: 60px;
    }
    
    /* D√âCALAGE LOGO + TITRE SEULEMENT SUR DESKTOP */
    @media (min-width: 1025px) {
        .logo-section {
            transform: translateX(50px);
        }
    }
    
    .logo-float {
        transform: translateY(0) scale(1);
        transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
    }
    
    /* Animation √©l√©gante du logo SANS ROTATION */
    .logo-float::before {
        content: "";
        position: absolute;
        top: -5px;
        left: -5px;
        right: -5px;
        bottom: -5px;
        border: 2px solid var(--gold-primary);
        border-radius: 50%;
        opacity: 0;
        transform: scale(0.8);
        transition: all 0.4s ease;
    }
    
    .logo-float:hover {
        transform: translateY(-5px) scale(1.05); /* Suppression de rotate */
    }
    
    .logo-float:hover::before {
        opacity: 0.3;
        transform: scale(1.1);
        animation: logoHalo 2s ease-in-out infinite;
    }
    
    @keyframes logoHalo {
        0%, 100% { 
            opacity: 0.3; 
            transform: scale(1.1);
        }
        50% { 
            opacity: 0.6; 
            transform: scale(1.15);
        }
    }
    
    .logo-float img {
        height: 50px;
        width: auto;
        display: block;
        transition: all 0.6s ease;
        filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.1));
    }
    
    .piano-header.scrolled .logo-float img {
        height: 40px;
    }
    
    .brand-text {
        cursor: pointer;
        transition: all 0.4s ease;
    }
    
    .brand-text:hover {
        transform: translateX(3px);
    }
    
    /* Animation dor√©e SIMPLE et RECTILIGNE sur PianoMode */
    .brand-text h1 {
        font-size: 32px;
        font-weight: 900;
        letter-spacing: 2px;
        margin: 0;
        color: var(--white-pure);
        font-family: "Montserrat", sans-serif;
        text-shadow: 
            0 2px 4px rgba(0,0,0,0.3),
            0 0 20px rgba(255, 255, 255, 0.1);
        white-space: nowrap;
        transition: all 0.4s ease;
    }
    
    /* S√©parer chaque lettre pour l'animation simple */
    .brand-text h1 .piano-letter {
        display: inline-block;
        transition: color 0.3s ease;
        color: var(--white-pure);
    }
    
    /* Les O restent dor√©s en permanence */
    .brand-text h1 .letter-o {
        color: var(--gold-bright) !important;
        filter: drop-shadow(0 0 8px rgba(212, 175, 71, 0.4));
    }
    
    /* Animation dor√©e SIMPLE au hover du header */
    .piano-header:hover .brand-text h1 .piano-letter {
        color: var(--gold-bright);
        text-shadow: 0 0 15px rgba(212, 175, 71, 0.6);
    }
    
    .piano-header.scrolled .brand-text h1 {
        font-size: 28px;
    }
    
    /* PHRASE ANIM√âE AU CHARGEMENT */
    .brand-text p {
        font-size: 10px;
        letter-spacing: 1.2px;
        text-transform: uppercase;
        color: rgba(255, 255, 255, 0.8);
        margin: 0;
        font-family: "Montserrat", sans-serif;
        white-space: nowrap;
        width: 210px;
        transition: all 0.2s ease;
        overflow: hidden;
        position: relative;
    }
    
    /* Animation typing pour la phrase */
    .brand-text p.typing {
        animation: typingEffect 2s ease-in-out;
    }
    
    .brand-text p.typing::after {
        content: "|";
        color: var(--gold-primary);
        animation: blinkCursor 1s infinite;
        position: absolute;
        right: 0;
    }
    
    @keyframes typingEffect {
        0% { 
            width: 0; 
            opacity: 0;
        }
        20% { 
            opacity: 1;
        }
        80% { 
            opacity: 1;
        }
        100% { 
            width: 210px; 
            opacity: 1;
        }
    }
    
    @keyframes blinkCursor {
        0%, 50% { opacity: 1; }
        51%, 100% { opacity: 0; }
    }
    
    /* SOUS-TITRE CACH√â AU SCROLL */
    .piano-header.scrolled .brand-text p {
        opacity: 0;
        height: 0;
        margin: 0;
    }
    
    /* NAVIGATION STABILIS√âE */
    .nav-container {
        flex-grow: 1;
        display: flex;
        justify-content: center;
        min-height: 60px;
        align-items: center;
    }
    
    .nav-menu {
        display: flex;
        list-style: none;
        align-items: center;
        gap: 35px;
        margin: 0;
        padding: 0;
        height: 60px;
    }
    
    .nav-menu a {
        color: var(--white-soft);
        text-decoration: none;
        font-size: 13px;
        font-weight: 600;
        letter-spacing: 1.5px;
        text-transform: uppercase;
        padding: 8px 0;
        position: relative;
        transition: all 0.4s ease;
        font-family: "Montserrat", sans-serif;
        white-space: nowrap;
    }
    
    .nav-menu a:hover {
        color: var(--gold-bright);
        transform: translateY(-2px);
        text-shadow: 0 0 12px rgba(212, 175, 71, 0.4);
    }
    
    .nav-menu a.active {
        color: var(--gold-primary);
        text-shadow: 0 0 8px rgba(197, 157, 58, 0.3);
    }
    
    /* DROPDOWN MORE MENU */
    .nav-more {
        position: relative;
    }
    
    .nav-more-trigger {
        display: flex;
        flex-direction: row; /* Colonne pour mettre les points en dessous */
        align-items: center;
        gap: 2px; /* Espace entre MORE et les points */
        cursor: pointer;
        color: var(--white-soft);
        text-decoration: none;
        font-size: 13px;
        font-weight: 600;
        letter-spacing: 1.5px;
        text-transform: uppercase;
        transition: all 0.4s ease;
        font-family: "Montserrat", sans-serif;
        white-space: nowrap;
    }
    
    .nav-more-trigger:hover {
        color: var(--gold-bright);
        transform: translateY(-2px);
        text-shadow: 0 0 12px rgba(212, 175, 71, 0.4);
    }
    
    /* Variables de r√©glage fin (optionnelles) */
    /* ===============================
   MORE icon ‚Äî 3 bars "tempo" baseline
   =============================== */

    /* Variables r√©glage fin */
    :root{
    --more-bars-gap: 2px;            /* espace entre les barres */
    --more-bars-thickness: 2px;      /* √©paisseur des barres */
    --more-bars-w1: 2.5px;            /* longue */
    --more-bars-w2: 5.5px;            /* moyenne */
    --more-bars-w3: 9px;             /* courte */
    --more-rot: 90deg;              /* rotation sens inverse */
    --more-offset-x: -10px;            /* micro offset horizontal */
    --more-offset-y: 5px;            /* micro offset vertical (caler avec le E) */
    }

    /* Texte + ic√¥ne sur la m√™me ligne */
    .nav-more-trigger{
    display:flex;
    align-items:center;  /* cal√© sur la ligne du "E" de MORE */
    gap:2px;
    line-height:1;
    }

    /* Ic√¥ne : on aligne √† DROITE AVANT rotation ‚Üí devient BAS apr√®s rotation */
    .nav-more-icon{
    position:relative;
    width:16px;  /* hitbox stable */
    height:calc(var(--more-bars-thickness)*3 + var(--more-bars-gap)*2);
    display:flex;
    flex-direction:column;
    align-items:flex-end;                 /* cl√© du baseline apr√®s rotation */
    gap:var(--more-bars-gap);

    transform-origin:right center;        /* pour ne pas d√©placer l‚Äôic√¥ne */
    transform:translate(var(--more-offset-x), var(--more-offset-y)) rotate(var(--more-rot));
    will-change:transform;
    }

    /* Barres */
    .nav-more-icon span{
    display:block;
    height:var(--more-bars-thickness);
    background:var(--white-soft);
    border-radius:999px;
    transition:background .25s ease, transform .25s ease;
    }

    /* largeurs (avant rot) ‚Üí hauteurs visuelles (apr√®s rot) */
    .nav-more-icon span:nth-child(1){ width:var(--more-bars-w1); } /* longue */
    .nav-more-icon span:nth-child(2){ width:var(--more-bars-w2); } /* moyenne */
    .nav-more-icon span:nth-child(3){ width:var(--more-bars-w3); } /* courte */

    /* Hover dor√© */
    .nav-more:hover .nav-more-icon span{ background:var(--gold-bright); }

    /* Option mobile (un peu plus lisible) */
    @media (max-width:480px){
    :root{
        --more-bars-thickness:2.5px;
        --more-bars-w1:16px;
        --more-bars-w2:12px;
        --more-bars-w3:8px;
        --more-offset-y:1px;
    }
    }


    
    .nav-more-dropdown {
        position: absolute;
        top: calc(100% + 15px);
        left: 50%;
        transform: translateX(-50%);
        min-width: 200px;
        background: rgba(30, 30, 30, 0.95);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 12px;
        padding: 15px 0;
        opacity: 0;
        visibility: hidden;
        transform: translateX(-50%) translateY(-10px);
        transition: all 0.3s ease;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .nav-more:hover .nav-more-dropdown,
    .nav-more-dropdown:hover {
        opacity: 1;
        visibility: visible;
        transform: translateX(-50%) translateY(0);
    }
    
    .nav-more-dropdown::before {
        content: "";
        position: absolute;
        top: -6px;
        left: 50%;
        transform: translateX(-50%);
        width: 12px;
        height: 12px;
        background: rgba(30, 30, 30, 0.95);
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        border-left: 1px solid rgba(255, 255, 255, 0.1);
        transform: translateX(-50%) rotate(45deg);
    }
    
    .nav-more-dropdown a {
        display: block;
        padding: 12px 25px;
        color: rgba(255, 255, 255, 0.9);
        text-decoration: none;
        font-size: 12px;
        font-weight: 600;
        letter-spacing: 1px;
        text-transform: uppercase;
        transition: all 0.3s ease;
        font-family: "Montserrat", sans-serif;
    }
    
    .nav-more-dropdown a:hover {
        background: rgba(197, 157, 58, 0.15);
        color: var(--gold-bright);
        transform: translateX(0px);
    }
    
    /* Fait descendre l'ancre sous le header sticky */
    #start-here {
      scroll-margin-top: -100px;
    }
    
    /* BUTTONS CONTAINER */
    .buttons-container {
        flex-shrink: 0;
        min-height: 60px;
        display: flex;
        align-items: center;
        gap: 20px;
    }
    
    @media (min-width: 1025px) {
        .buttons-container {
            transform: translateX(-50px);
        }
    }

    /* BOUTONS UNIFI√âS : Search et Account avec m√™me style */
    .search-btn,
    .account-btn,
    .burger-btn {
        width: 46px;
        height: 46px;
        border-radius: 50%;
        background: var(--gray-light);
        backdrop-filter: blur(15px);
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }
    
    /* Animation de hover pour tous les boutons */
    .search-btn::before,
    .account-btn::before,
    .burger-btn::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        background: var(--gold-primary);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        transition: all 0.4s ease;
        z-index: -1;
    }
    
    .piano-header.scrolled .search-btn,
    .piano-header.scrolled .account-btn,
    .piano-header.scrolled .burger-btn {
        width: 40px;
        height: 40px;
    }
    
    .search-btn:hover,
    .account-btn:hover,
    .burger-btn:hover {
        background: rgba(212, 175, 71, 0.15);
        transform: scale(1.08) rotate(5deg);
        box-shadow: 0 8px 20px rgba(212, 175, 71, 0.2);
    }
    
    .search-btn:hover::before,
    .account-btn:hover::before,
    .burger-btn:hover::before {
        width: 60px;
        height: 60px;
        opacity: 0.1;
    }
    
    .search-btn svg,
    .account-btn svg {
        width: 20px;
        height: 20px;
        stroke: var(--white-soft);
        stroke-width: 2.5;
        fill: none;
        transition: all 0.3s ease;
        z-index: 1;
    }
    
    .search-btn:hover svg,
    .account-btn:hover svg {
        stroke: var(--gold-bright);
        transform: scale(1.1);
    }
    
    /* BURGER ICON AM√âLIOR√â */
    .burger-btn {
        display: none;
        flex-direction: column;
        gap: 4px;
        padding: 0;
        background: rgba(0, 0, 0, 0.7) !important;
        backdrop-filter: blur(15px) !important;
        border: none !important;
    }
    
    .burger-line {
        width: 22px;
        height: 2px;
        background: var(--white-soft);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        border-radius: 2px;
        transform-origin: center;
    }
    
    .burger-btn:hover .burger-line {
        background: var(--gold-bright);
        box-shadow: 0 0 8px rgba(212, 175, 71, 0.3);
    }
    
    .burger-btn.active .burger-line:nth-child(1) {
        transform: rotate(45deg) translate(6px, 6px);
    }
    
    .burger-btn.active .burger-line:nth-child(2) {
        opacity: 0;
        transform: scale(0);
    }
    
    .burger-btn.active .burger-line:nth-child(3) {
        transform: rotate(-45deg) translate(6px, -6px);
    }
    
    /* MOBILE MENU AM√âLIOR√â */
    .mobile-menu {
        position: fixed;
        top: 0;
        right: -100%;
        width: 320px;
        max-width: 90%;
        height: 100vh;
        background: linear-gradient(135deg, 
            rgba(255, 255, 255, 0.95) 0%,
            rgba(240, 240, 240, 0.95) 100%);
        backdrop-filter: blur(25px);
        -webkit-backdrop-filter: blur(25px);
        transition: right 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 999998;
        padding: 30px;
        overflow-y: auto;
        border: none;
    }
    
    .mobile-menu.active {
        right: 0;
    }
    
    .mobile-menu-header {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 50px;
        padding-bottom: 30px;
        border: none;
    }
    
    .mobile-menu-header img {
        height: 60px;
        filter: drop-shadow(0 4px 10px rgba(0,0,0,0.2));
    }
    
    .mobile-search {
        margin-bottom: 40px;
    }
    
    .mobile-search input {
        width: 100%;
        padding: 15px 20px;
        background: rgba(255, 255, 255, 0.8);
        border: none;
        border-radius: 30px;
        color: #333;
        font-family: "Montserrat", sans-serif;
        font-size: 14px;
        outline: none;
        transition: all 0.3s ease;
    }
    
    .mobile-search input:focus {
        background: rgba(255, 255, 255, 0.95);
        box-shadow: 0 0 20px rgba(197, 157, 58, 0.2);
    }
    
    .mobile-search input::placeholder {
        color: rgba(100, 100, 100, 0.7);
    }
    
    .mobile-nav {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .mobile-nav li {
        margin-bottom: 25px;
    }
    
    .mobile-nav a {
        color: #333;
        text-decoration: none;
        font-size: 16px;
        font-weight: 600;
        letter-spacing: 1.5px;
        text-transform: uppercase;
        font-family: "Montserrat", sans-serif;
        transition: all 0.3s ease;
        display: block;
        padding: 10px 0;
        position: relative;
    }
    
    .mobile-nav a:hover,
    .mobile-nav a.active {
        color: var(--gold-primary);
        transform: translateX(10px);
    }
    
    /* S√©parateur dans le menu mobile */
    .mobile-nav-separator {
        height: 1px;
        background: rgba(0, 0, 0, 0.1);
        margin: 20px 0;
    }
    
    .mobile-menu-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        z-index: 999997;
        backdrop-filter: blur(5px);
    }
    
    .mobile-menu-overlay.active {
        opacity: 1;
        visibility: visible;
    }
    
    /* HERO SECTION AVEC D√âGRAD√â AJUST√â */
    .hero-immersive {
        position: relative;
        height: 100vh;
        overflow: hidden;
        background: #000;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: 0;
        margin-bottom: 40px;
        border: none;
        outline: none;
    }
    
    /* D√©grad√© blanc plus bas pour ne pas cacher le bouton */
    .hero-immersive::after {
        content: "";
        position: absolute;
        bottom: -1px;
        left: 0;
        right: 0;
        height: 200px;
        background: linear-gradient(to top, 
            #ffffff 0%,
            rgba(255, 255, 255, 0.99) 2%,
            rgba(255, 255, 255, 0.95) 8%,
            rgba(255, 255, 255, 0.9) 15%,
            rgba(255, 255, 255, 0.8) 25%,    
            rgba(255, 255, 255, 0.6) 40%,    
            rgba(255, 255, 255, 0.4) 60%,    
            rgba(255, 255, 255, 0.2) 80%,    
            rgba(255, 255, 255, 0.05) 95%,   
            transparent 100%);
        z-index: 3;
        pointer-events: none;
    }
    
    .hero-video {
        position: absolute;
        top: 50%;
        left: 50%;
        min-width: 100%;
        min-height: 100%;
        width: auto;
        height: auto;
        transform: translate(-50%, -50%);
        opacity: 0.7;
        object-fit: cover;
    }
    
    .hero-mobile-bg {
        display: none;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-size: cover;
        background-position: center;
    }
    
    .hero-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(ellipse at center, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.7) 100%);
        z-index: 1;
    }
    
    .hero-content {
        position: relative;
        z-index: 2;
        text-align: center;
        color: #fff;
        padding: 0 20px;
    }
    
    .hero-title {
        font-size: clamp(48px, 8vw, 96px);
        font-weight: 900;
        letter-spacing: -2px;
        margin-bottom: 30px;
        color: #fff;
        font-family: "Montserrat", sans-serif;
        line-height: 1.1;
    }
    
    .hero-word {
        display: inline-block;
        opacity: 0;
        animation: fadeInUp 0.6s ease forwards;
        margin: 0 4px;
        color: #fff;
    }
    
    .hero-word:nth-child(1) { animation-delay: 0.5s; }
    .hero-word:nth-child(2) { animation-delay: 0.7s; }
    .hero-word:nth-child(3) { animation-delay: 0.9s; }
    .hero-word:nth-child(4) { animation-delay: 1.1s; }
    .hero-word:nth-child(5) { animation-delay: 1.3s; }
    .hero-word:nth-child(6) { animation-delay: 1.5s; }
    .hero-word:nth-child(7) { animation-delay: 1.7s; }
    .hero-word:nth-child(8) { animation-delay: 1.9s; }
    
    .hero-word span {
        color: var(--gold-primary);
    }
    
    .hero-description {
        font-size: clamp(16px, 2vw, 20px);
        font-weight: 400;
        letter-spacing: 0.5px;
        line-height: 1.6;
        max-width: 800px;
        margin: 0 auto 50px;
        opacity: 0;
        animation: fadeInUp 0.8s ease forwards;
        animation-delay: 2.2s;
        color: #fff;
        font-family: "Montserrat", sans-serif;
    }
    
    @keyframes fadeInUp {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* GET STARTED BUTTON REDESIGN */
    .hero-get-started {
        opacity: 0;
        animation: fadeInUp 0.8s ease forwards;
        animation-delay: 2.8s;
        display: inline-flex;
        align-items: center;
        gap: 15px;
        cursor: pointer;
        padding: 16px 32px;
        background: transparent;
        border-radius: 50px;
        border: 2px solid var(--gold-primary);
        transition: all 0.4s ease;
        position: relative;
        overflow: hidden;
    }
    
    .hero-get-started::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        background: var(--gold-primary);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        transition: width 0.6s ease, height 0.6s ease;
    }
    
    .hero-get-started:hover::before {
        width: 300px;
        height: 300px;
    }
    
    .hero-get-started:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 30px rgba(197, 157, 58, 0.3);
    }
    
    .hero-get-started:hover .get-started-text,
    .hero-get-started:hover .arrow-down svg {
        color: #000;
        stroke: #000;
    }
    
    .get-started-text {
        font-size: 14px;
        font-weight: 700;
        letter-spacing: 2px;
        text-transform: uppercase;
        color: #fff;
        font-family: "Montserrat", sans-serif;
        position: relative;
        z-index: 1;
        transition: color 0.3s ease;
    }
    
    .arrow-down {
        width: 20px;
        height: 20px;
        position: relative;
        z-index: 1;
        animation: arrowBounce 2s ease-in-out infinite;
    }
    
    .arrow-down svg {
        width: 100%;
        height: 100%;
        stroke: #fff;
        stroke-width: 2.5;
        fill: none;
        stroke-linecap: round;
        stroke-linejoin: round;
        transition: stroke 0.3s ease;
    }
    
    @keyframes arrowBounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(3px); }
    }
    
    /* RESPONSIVE */
    @media (max-width: 1024px) {
        .nav-menu {
            gap: 25px;
        }
        
        .nav-menu a {
            font-size: 12px;
        }
    }
    
    @media (max-width: 850px) {
        /* AJUSTEMENT HERO MOBILE - comme avant */
        .entry-content > *:first-child,
        .hero-section,
        .page-hero,
        .pianomode-hero-explore {
            padding-top: 95px !important; /* Comme avant */
            margin-top: -15px !important; /* Comme avant */
        }
        
        .main-nav {
            padding: 18px 30px 26px;
            grid-template-columns: 1fr auto;
            max-width: 100%;
            gap: 20px;
        }
        
        .piano-header.scrolled .main-nav {
            padding: 12px 30px 12px;
        }
        
        .nav-container {
            display: none;
        }
        
        .search-btn {
            display: none;
        }
        
        /* Masquer le bouton Account sur mobile/tablette */
        .account-btn {
            display: none !important;
        }
        
        .burger-btn {
            display: flex;
            background: rgba(0, 0, 0, 0.8) !important;
            border: none !important;
        }
        
        .logo-section {
            margin-left: 0;
        }
        
        .logo-float img { 
            height: 40px; 
        }
        
        .piano-header.scrolled .logo-float img {
            height: 35px;
        }
        
        .brand-text h1 { 
            font-size: 26px; 
        }
        
        .piano-header.scrolled .brand-text h1 {
            font-size: 22px;
        }
        
        .brand-text p { 
            font-size: 9px;
            letter-spacing: 1.2px;
        }
        
        .hero-immersive::after {
            height: 250px;
            background: linear-gradient(to top, 
                rgba(255, 255, 255, 1) 0%,
                rgba(255, 255, 255, 0.98) 5%,
                rgba(255, 255, 255, 0.9) 15%,
                rgba(255, 255, 255, 0.7) 30%,
                rgba(255, 255, 255, 0.5) 50%,
                rgba(255, 255, 255, 0.2) 70%,
                rgba(255, 255, 255, 0.05) 85%,
                transparent 100%);
        }
    }
    
    @media (max-width: 480px) {
        /* AJUSTEMENT HERO PETIT √âCRAN - comme avant */
        .entry-content > *:first-child,
        .hero-section,
        .page-hero,
        .pianomode-hero-explore {
            padding-top: 70px !important; /* Comme avant */
            margin-top: -10px !important; /* Comme avant */
        }
        
        /* HEADER TR√àS PETIT √âCRAN FULL WIDTH */
        .piano-header {
            height: 100px;
        }
        
        .main-nav {
            height: 68px;
            padding: 0;
            width: 100% !important;
        }
        
        .main-nav .nav-content-wrapper {
            padding: 0 20px;
        }
        
        .piano-header.scrolled .main-nav {
            height: 60px;
            padding: 0;
        }
        
        .piano-header.scrolled .main-nav .nav-content-wrapper {
            padding: 0 20px;
        }
        
        .brand-text h1 { 
            font-size: 22px; 
        }
        
        .brand-text p { 
            display: none; 
        }
        
        .hero-video { 
            display: none; 
        }
        
        .hero-mobile-bg { 
            display: block; 
        }
        
        .hero-title {
            font-size: 36px;
        }
        
        .hero-get-started {
            padding: 14px 26px;
        }
        
        .get-started-text {
            font-size: 12px;
        }
        
        .burger-btn {
            background: rgba(0, 0, 0, 0.9) !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5) !important;
            border: none !important;
        }
        
        .hero-immersive {
            border: none !important;
            outline: none !important;
            box-shadow: none !important;
            -webkit-appearance: none !important;
        }
        
        .hero-immersive::after {
            bottom: -3px !important;
            height: 300px !important;
            background: linear-gradient(to top, 
                #ffffff 0%,
                #ffffff 2%,
                rgba(255, 255, 255, 0.98) 8%,
                rgba(255, 255, 255, 0.9) 18%,
                rgba(255, 255, 255, 0.75) 30%,
                rgba(255, 255, 255, 0.6) 45%,
                rgba(255, 255, 255, 0.4) 60%,
                rgba(255, 255, 255, 0.2) 75%,
                rgba(255, 255, 255, 0.05) 90%,
                transparent 100%) !important;
        }
    }
    </style>
    
    <script>
    if (<?php echo $is_home ? 'true' : 'false'; ?>) {
        document.body.classList.add("home-page");
    }
    </script>
    <?php
    
    // HTML du header avec lettres s√©par√©es pour animation
    $current_url = $_SERVER['REQUEST_URI'];
    $current_url = rtrim($current_url, '/');
    ?>
    
    <header class="piano-header" id="pianoHeader">
        <div class="top-bar">
            ‚ô™ New Posts Weekly ‚Ä¢ Join The PianoMode Community ‚ô™
        </div>
        
        <nav class="main-nav">
            <div class="nav-content-wrapper">
                <div class="logo-section">
                    <div class="logo-float">
                        <a href="<?php echo home_url(); ?>">
                            <img src="<?php echo esc_url($logo_url); ?>" alt="PianoMode">
                        </a>
                    </div>
                    <div class="brand-text" onclick="window.location.href='<?php echo home_url(); ?>'">
                        <h1>
                            <span class="piano-letter">P</span><span class="piano-letter">i</span><span class="piano-letter">a</span><span class="piano-letter">n</span><span class="piano-letter letter-o">o</span><span class="piano-letter">M</span><span class="piano-letter letter-o">o</span><span class="piano-letter">d</span><span class="piano-letter">e</span>
                        </h1>
                        <p id="typingText">Always the Right Time to Play</p>
                    </div>
                </div>
                
                <div class="nav-container">
                    <ul class="nav-menu">
                        <li><a href="/" class="<?php echo (($current_url === '' || $current_url === '/') ? 'active' : ''); ?>">Home</a></li>
                        <li><a href="/listen-and-play" class="<?php echo ($current_url === '/listen-and-play' ? 'active' : ''); ?>">Listen & Play</a></li>
                        <li><a href="/explore" class="<?php echo ($current_url === '/explore' ? 'active' : ''); ?>">Explore</a></li>
                        <li class="nav-more">
                            <div class="nav-more-trigger">
                                <span>More</span>
                                <div class="nav-more-icon">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </div>
                            </div>
                            <div class="nav-more-dropdown">
                                <a href="/about-us">About Us</a>
                                <a href="/contact-us">Contact Us</a>
                            </div>
                        </li>
                    </ul>
                </div>
                
                <div class="buttons-container">
                    <button class="search-btn" id="searchBtn">
                        <svg viewBox="0 0 24 24" fill="none">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="m21 21-4.35-4.35"/>
                        </svg>
                    </button>
                    <!-- PLACER ICI CODE BOUTON ACCOUNT (account-button) -->
                    <button class="burger-btn" id="burgerBtn">
                        <span class="burger-line"></span>
                        <span class="burger-line"></span>
                        <span class="burger-line"></span>
                    </button>
                </div>
            </div>
        </nav>
    </header>
    
    <!-- Mobile Menu -->
    <div class="mobile-menu-overlay" id="mobileMenuOverlay"></div>
    <div class="mobile-menu" id="mobileMenu">
        <div class="mobile-menu-header">
            <img src="<?php echo esc_url($logo_url); ?>" alt="PianoMode">
        </div>
        
        <div class="mobile-search">
            <form action="/" method="get">
                <input type="text" name="s" placeholder="Search PianoMode..." />
            </form>
        </div>
        
        <ul class="mobile-nav">
            <li><a href="/" class="<?php echo (($current_url === '' || $current_url === '/') ? 'active' : ''); ?>">Home</a></li>
            <li><a href="/listen-and-play" class="<?php echo ($current_url === '/listen-and-play' ? 'active' : ''); ?>">Listen & Play</a></li>
            <li><a href="/explore" class="<?php echo ($current_url === '/explore' ? 'active' : ''); ?>">Explore</a></li>
            <div class="mobile-nav-separator"></div>
            <li><a href="/about-us" class="<?php echo ($current_url === '/about-us' ? 'active' : ''); ?>">About Us</a></li>
            <li><a href="/contact-us" class="<?php echo ($current_url === '/contact-us' ? 'active' : ''); ?>">Contact Us</a></li>
        </ul>
    </div>
    
    <?php if ($is_home) : ?>
    <section class="hero-immersive" id="heroSection">
        <video class="hero-video" autoplay muted loop playsinline>
            <source src="<?php echo esc_url($video_url); ?>" type="video/mp4">
        </video>
        
        <div class="hero-mobile-bg" style="background-image: url('<?php echo esc_url($mobile_bg); ?>')"></div>
        
        <div class="hero-overlay"></div>
        
        <div class="hero-content">
            <h1 class="hero-title">
                <span class="hero-word">Listen</span><span class="hero-word">,</span>
                <span class="hero-word">Learn</span><span class="hero-word">,</span>
                <span class="hero-word">Play</span><span class="hero-word">,</span>
                <span class="hero-word">Expl<span>o</span>re</span><span class="hero-word">.</span>
            </h1>
            <p class="hero-description">
                Discover the world of piano from step-by-step tutorials to iconic albums, inspiring pianists, sheet music and gear guides
            </p>
            <div class="hero-get-started" id="getStarted">
                <div class="get-started-text">Get Started</div>
                <div class="arrow-down">
                    <svg viewBox="0 0 24 24">
                        <path d="M7 10l5 5 5-5"/>
                    </svg>
                </div>
            </div>
        </div>
    </section>
    <?php endif; ?>
    
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        // Animation typing pour "Always the Right Time to Play"
        function startTypingAnimation() {
            const typingText = document.getElementById("typingText");
            if (typingText) {
                typingText.textContent = "";
                typingText.classList.add("typing");
                
                const text = "Always the Right Time to Play";
                let index = 0;
                
                function typeChar() {
                    if (index < text.length) {
                        typingText.textContent += text.charAt(index);
                        index++;
                        setTimeout(typeChar, 80);
                    } else {
                        setTimeout(() => {
                            typingText.classList.remove("typing");
                        }, 2000);
                    }
                }
                
                setTimeout(typeChar, 1000);
            }
        }
        
        startTypingAnimation();
        
        // Optimized scroll avec transition fluide
        let ticking = false;
        let lastScrollY = 0;
        
        function updateHeader() {
            const header = document.getElementById("pianoHeader");
            const currentScrollY = window.pageYOffset;
            
            if (currentScrollY > 100) {
                header.classList.add("scrolled");
            } else {
                header.classList.remove("scrolled");
            }
            
            lastScrollY = currentScrollY;
            ticking = false;
        }
        
        window.addEventListener("scroll", function() {
            if (!ticking) {
                window.requestAnimationFrame(updateHeader);
                ticking = true;
            }
        });
        
        // Mobile Menu
        const burgerBtn = document.getElementById("burgerBtn");
        const mobileMenu = document.getElementById("mobileMenu");
        const mobileMenuOverlay = document.getElementById("mobileMenuOverlay");
        
        if (burgerBtn) {
            burgerBtn.addEventListener("click", function() {
                burgerBtn.classList.toggle("active");
                mobileMenu.classList.toggle("active");
                mobileMenuOverlay.classList.toggle("active");
                document.body.style.overflow = mobileMenu.classList.contains("active") ? "hidden" : "";
            });
            
            mobileMenuOverlay.addEventListener("click", function() {
                burgerBtn.classList.remove("active");
                mobileMenu.classList.remove("active");
                mobileMenuOverlay.classList.remove("active");
                document.body.style.overflow = "";
            });
        }
        
        // Desktop Search am√©lior√©
        const searchBtn = document.getElementById("searchBtn");
        if (searchBtn) {
            searchBtn.addEventListener("click", function() {
                const searchOverlay = document.createElement("div");
                searchOverlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(240,240,240,0.95));
                    backdrop-filter: blur(25px);
                    z-index: 999999;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    opacity: 0;
                    transition: opacity 0.4s ease;
                `;
                
                searchOverlay.innerHTML = `
                    <div style="text-align:center; max-width:700px; width:90%;">
                        <h2 style="margin-bottom:40px; color:#C59D3A; font-family:Montserrat,sans-serif; font-size:28px; font-weight:700; text-shadow: 0 0 20px rgba(197,157,58,0.3);">
                            Search PianoMode
                        </h2>
                        <form action="/" method="get" style="position:relative; margin-bottom:30px;">
                            <input type="text" name="s" placeholder="Search articles, tutorials, songs..." 
                                style="width:100%; padding:25px 70px 25px 30px; font-size:18px; border:2px solid #C59D3A; border-radius:60px; background:rgba(255,255,255,0.8); color:#333; font-family:Montserrat,sans-serif; outline:none; box-shadow: 0 10px 30px rgba(197,157,58,0.1);" 
                                autofocus>
                            <button type="submit" style="position:absolute; right:8px; top:50%; transform:translateY(-50%); background:#C59D3A; border:none; border-radius:50px; width:50px; height:80%; cursor:pointer; display:flex; align-items:center; justify-content:center; transition: all 0.3s ease;">
                                <svg viewBox="0 0 24 24" fill="none" style="width:22px; height:22px;">
                                    <circle cx="11" cy="11" r="8" stroke="white" stroke-width="2.5"/>
                                    <path d="m21 21-4.35-4.35" stroke="white" stroke-width="2.5"/>
                                </svg>
                            </button>
                        </form>
                        <p style="margin:0; opacity:0.7; font-family:Montserrat,sans-serif; font-size:14px; color:#666;">
                            Press ESC to close
                        </p>
                    </div>
                `;
                
                document.body.appendChild(searchOverlay);
                setTimeout(function() { searchOverlay.style.opacity = "1"; }, 10);
                
                function closeSearch() {
                    searchOverlay.style.opacity = "0";
                    setTimeout(function() {
                        if (document.body.contains(searchOverlay)) {
                            document.body.removeChild(searchOverlay);
                        }
                    }, 400);
                }
                
                searchOverlay.addEventListener("click", function(e) {
                    if (e.target === searchOverlay) closeSearch();
                });
                
                document.addEventListener("keydown", function handler(e) {
                    if (e.key === "Escape") {
                        closeSearch();
                        document.removeEventListener("keydown", handler);
                    }
                });
            });
        }
        
        // Get Started smooth scroll
        const getStarted = document.getElementById("getStarted");
        if (getStarted) {
            getStarted.addEventListener("click", function() {
                const startHere = document.getElementById("start-here");
                if (startHere) {
                    startHere.scrollIntoView({ behavior: "smooth" });
                } else {
                    window.scrollTo({ top: window.innerHeight, behavior: "smooth" });
                }
            });
        }
    });
    </script>

    <?php
}
add_action('wp_head', 'pianomode_complete_design');

// FOOTER OPTIMIS√â AVEC LIEN YOUR ACCOUNT
function pianomode_footer_glassmorphism() {
    $current_url = $_SERVER['REQUEST_URI'];
    $current_url = rtrim($current_url, '/');
    ?>
    <footer class="pianomode-footer">
        <div class="footer-container">
            <nav class="footer-nav">
                <ul class="footer-links">
                    <li><a href="/about-us">About Us</a></li>
                    <li><a href="/contact-us">Contact Us</a></li>
                    <li><a href="/privacy-policy">Privacy Policy</a></li>
                    <li><a href="/cookie-policy">Cookie Policy</a></li>
                </ul>
            </nav>
            <div class="footer-copyright">
                <p>¬© <?php echo date('Y'); ?> PianoMode - All rights reserved</p>
            </div>
        </div>
        <button id="backToTop" class="back-to-top-btn" aria-label="Back to top">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 15l-6-6-6 6"/>
            </svg>
        </button>
    </footer>
    
    <style>
    .pianomode-footer {
        background: linear-gradient(to bottom, 
            transparent 0%,
            rgba(0, 0, 0, 0.4) 20%,
            rgba(0, 0, 0, 0.75) 60%,
            #1a1a1a 100%);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        padding: 80px 0 40px;
        margin-top: 100px;
        position: relative;
        overflow: hidden;
        width: 100%;
        font-family: "Montserrat", sans-serif;
    }
    
    .footer-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
        position: relative;
        z-index: 2;
    }
    
    .footer-nav {
        margin-bottom: 40px;
    }
    
    .footer-links {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 60px;
        list-style: none;
        margin: 0;
        padding: 0;
        flex-wrap: wrap;
    }
    
    .footer-links a {
        color: rgba(255, 255, 255, 0.9);
        text-decoration: none;
        font-size: 13px;
        font-weight: 600;
        letter-spacing: 1px;
        text-transform: uppercase;
        transition: all 0.25s ease;
        position: relative;
        font-family: "Montserrat", sans-serif;
    }
    
    .footer-links a:hover {
        color: #C59D3A;
        transform: translateY(-2px);
    }
    
    .footer-links a::after {
        content: "";
        position: absolute;
        bottom: -5px;
        left: 0;
        width: 0;
        height: 1px;
        background: #C59D3A;
        transition: width 0.25s ease;
    }
    
    .footer-links a:hover::after {
        width: 100%;
    }
    
    .footer-copyright p {
        color: rgba(255, 255, 255, 0.6);
        font-size: 11px;
        letter-spacing: 2px;
        text-transform: uppercase;
        margin: 0;
        text-align: center;
        font-family: "Montserrat", sans-serif;
    }
    
    .back-to-top-btn {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, #C59D3A, #B8860B);
        border: none;
        border-radius: 50%;
        cursor: pointer;
        z-index: 9998;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transform: translateY(20px) scale(0.9);
        box-shadow: 0 5px 20px rgba(197, 157, 58, 0.3);
    }
    
    .back-to-top-btn.visible {
        opacity: 1;
        visibility: visible;
        transform: translateY(0) scale(1);
    }
    
    .back-to-top-btn:hover {
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 8px 25px rgba(197, 157, 58, 0.4);
    }
    
    .back-to-top-btn svg {
        width: 20px;
        height: 20px;
        stroke: #fff;
        stroke-width: 2.5;
        fill: none;
    }
    
    @media (max-width: 768px) {
        .footer-links { 
            gap: 30px; 
        }
        .footer-links a { 
            font-size: 11px; 
        }
        .pianomode-footer { 
            padding: 60px 0 30px; 
            margin-top: 60px; 
        }
        .back-to-top-btn { 
            bottom: 20px; 
            right: 20px; 
            width: 45px; 
            height: 45px; 
        }
    }
    </style>
    
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        let scrollTimer = null;
        window.addEventListener("scroll", function() {
            if (scrollTimer !== null) {
                clearTimeout(scrollTimer);
            }
            scrollTimer = setTimeout(function() {
                const backToTop = document.getElementById("backToTop");
                if (backToTop && window.pageYOffset > 300) {
                    backToTop.classList.add("visible");
                } else if (backToTop) {
                    backToTop.classList.remove("visible");
                }
            }, 150);
        });
        
        const backToTop = document.getElementById("backToTop");
        if (backToTop) {
            backToTop.addEventListener("click", function() {
                window.scrollTo({ top: 0, behavior: "smooth" });
            });
        }
    });
    </script>
    <?php
}
add_action('wp_footer', 'pianomode_footer_glassmorphism', 1);


/**
 * Enqueue Hero Listen & Play Assets
 */
function pianomode_enqueue_hero_listen_play() {
    // Seulement sur la page Listen & Play ou archive des scores
    if (!is_page('listen-and-play') && !is_post_type_archive('score')) {
        return;
    }
    
    // CSS du h√©ro
    wp_enqueue_style(
        'pianomode-hero-listen-play',
        get_stylesheet_directory_uri() . '/Listen & Play page/hero-listen-play.css',
        array(),
        '1.0.0'
    );
    
    // JavaScript du h√©ro
    wp_enqueue_script(
        'pianomode-hero-listen-play',
        get_stylesheet_directory_uri() . '/Listen & Play page/hero-listen-play.js',
        array('jquery'),
        '1.0.0',
        true
    );
    
    // Configuration JavaScript
    wp_localize_script('pianomode-hero-listen-play', 'pianoModeHero', array(
        'ajaxUrl' => admin_url('admin-ajax.php'),
        'nonce' => wp_create_nonce('pianomode_hero_nonce'),
        'debug' => WP_DEBUG
    ));
}
add_action('wp_enqueue_scripts', 'pianomode_enqueue_hero_listen_play');

/**
 * Shortcode Hero Listen & Play
 */
function pianomode_hero_listen_play_shortcode($atts = array()) {
    ob_start();
    include get_stylesheet_directory() . '/Listen & Play page/hero-listen-play.php';
    return ob_get_clean();
}
add_shortcode('pianomode_hero_listen_play', 'pianomode_hero_listen_play_shortcode');

/**
 * R√©cup√©rer les statistiques r√©elles du h√©ro
 */
function pianomode_get_hero_stats_reliable() {
    $cache_key = 'pianomode_hero_stats_v1';
    $stats = get_transient($cache_key);
    
    if (false === $stats) {
        // Compter les posts publi√©s
        $post_count = wp_count_posts('post');
        $total_posts = isset($post_count->publish) ? (int) $post_count->publish : 0;
        
        // Compter les cat√©gories
        $categories = get_categories(array('hide_empty' => false));
        $total_categories = count($categories);
        
        // Si post type 'score' existe, le compter
        $scores_count = 0;
        if (post_type_exists('score')) {
            $score_posts = wp_count_posts('score');
            $scores_count = isset($score_posts->publish) ? (int) $score_posts->publish : 0;
        }
        
        // Si taxonomie compositeur existe, la compter
        $composers_count = 0;
        if (taxonomy_exists('composer') || taxonomy_exists('score_composer')) {
            $taxonomy = taxonomy_exists('composer') ? 'composer' : 'score_composer';
            $terms = get_terms(array(
                'taxonomy' => $taxonomy,
                'hide_empty' => false
            ));
            if (!is_wp_error($terms)) {
                $composers_count = count($terms);
            }
        }
        
        // Calculer les statistiques finales
        $final_scores = 0;
        $final_composers = 0;
        
        if ($scores_count > 0) {
            $final_scores = $scores_count;
        } elseif ($total_posts > 0) {
            $final_scores = max(1, intval($total_posts * 0.7)); // 70% des posts
        } else {
            $final_scores = 25; // Fallback
        }
        
        if ($composers_count > 0) {
            $final_composers = $composers_count;
        } elseif ($total_categories > 0) {
            $final_composers = max(1, intval($total_categories * 0.3)); // 30% des cat√©gories
        } else {
            $final_composers = 8; // Fallback
        }
        
        $stats = array(
            'totalScores' => $final_scores,
            'totalComposers' => $final_composers,
            'lastUpdated' => current_time('timestamp'),
            'method' => $scores_count > 0 ? 'score_post_type' : ($total_posts > 0 ? 'posts_estimate' : 'fallback')
        );
        
        // Cache pour 30 minutes
        set_transient($cache_key, $stats, 30 * MINUTE_IN_SECONDS);
    }
    
    return $stats;
}

/**
 * R√©cup√©rer les images optimis√©es pour le h√©ro
 */
function pianomode_get_random_score_images_optimized($limit = 6) {
    $cache_key = 'pianomode_hero_images_v1_' . $limit;
    $images = get_transient($cache_key);
    
    if (false === $images) {
        $images = array();
        
        // Essayer de r√©cup√©rer des images depuis les posts avec featured image
        $posts_query = new WP_Query(array(
            'post_type' => array('post', 'score'),
            'posts_per_page' => $limit * 2,
            'orderby' => 'rand',
            'post_status' => 'publish',
            'meta_query' => array(
                array(
                    'key' => '_thumbnail_id',
                    'compare' => 'EXISTS'
                )
            )
        ));
        
        if ($posts_query->have_posts()) {
            while ($posts_query->have_posts() && count($images) < $limit) {
                $posts_query->the_post();
                $image_url = get_the_post_thumbnail_url(get_the_ID(), 'large');
                if ($image_url) {
                    $images[] = $image_url;
                }
            }
            wp_reset_postdata();
        }
        
        // Images fallback de qualit√©
        $fallback_images = array(
            'https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?w=500&q=85&fm=webp',
            'https://images.unsplash.com/photo-1507838153414-b4b713384a76?w=500&q=85&fm=webp',
            'https://images.unsplash.com/photo-1524368535928-5b5e00ddc76b?w=500&q=85&fm=webp',
            'https://images.unsplash.com/photo-1520523839897-bd0b52f945a0?w=500&q=85&fm=webp',
            'https://images.unsplash.com/photo-1521337581100-8ca9a73a5f79?w=500&q=85&fm=webp',
            'https://images.unsplash.com/photo-1452195100486-9cc805987862?w=500&q=85&fm=webp'
        );
        
        // Compl√©ter avec les images fallback si n√©cessaire
        while (count($images) < $limit) {
            $random_image = $fallback_images[array_rand($fallback_images)];
            if (!in_array($random_image, $images)) {
                $images[] = $random_image;
            }
        }
        
        // Cache pour 1 heure
        set_transient($cache_key, $images, HOUR_IN_SECONDS);
    }
    
    return $images;
}

/**
 * Nettoyer le cache des statistiques
 */
function pianomode_clear_hero_cache($post_id) {
    delete_transient('pianomode_hero_stats_v1');
    delete_transient('pianomode_hero_images_v1_6');
}
add_action('save_post', 'pianomode_clear_hero_cache');
add_action('publish_post', 'pianomode_clear_hero_cache');




/**
 * Shortcode Hero Explore Page
 */

require_once get_stylesheet_directory() . '/Explore page/functions-hero-explore.php';


/**
 * Shortcode Fonction Global Search (dans assets)
 */

require_once get_stylesheet_directory() . '/assets/global-search/search-functions.php';



// ===================================================
// ACTIVATION SYST√àME EXPLORE PREMIUM
// √Ä ajouter √† la fin de functions.php
// ===================================================

if (!defined('ABSPATH')) {
    exit;
}

// Activation du syst√®me Explore seulement si le fichier existe
function activate_explore_system_premium() {
    $explore_file = get_stylesheet_directory() . '/Explore page/functions-explore.php';
    
    if (file_exists($explore_file)) {
        require_once($explore_file);
        
        // Activation imm√©diate du syst√®me
        if (class_exists('ExploreSystemPremium')) {
            global $explore_system_premium_instance;
            $explore_system_premium_instance = new ExploreSystemPremium();
        }
        
        return true;
    }
    
    return false;
}

// Activation au chargement WordPress
add_action('after_setup_theme', 'activate_explore_system_premium', 5);

// Assets CSS et JS pour Explore
function enqueue_explore_premium_assets_global() {
    // Seulement sur les pages avec le shortcode ou page explore
    global $post;
    
    if (!$post) return;
    
    $has_shortcode = has_shortcode($post->post_content, 'horizontal_explore_content') || 
                     has_shortcode($post->post_content, 'explore_blocks_premium') ||
                     is_page('explore');
    
    if ($has_shortcode) {
        $theme_uri = get_stylesheet_directory_uri();
        
        // CSS Explore
        wp_enqueue_style(
            'explore-premium-styles',
            $theme_uri . '/Explore page/explore.css',
            array(),
            filemtime(get_stylesheet_directory() . '/Explore page/explore.css')
        );
        
        // JS Explore
        wp_enqueue_script(
            'explore-premium-scripts',
            $theme_uri . '/Explore page/explore.js',
            array('jquery'),
            filemtime(get_stylesheet_directory() . '/Explore page/explore.js'),
            true
        );
        
        // Configuration JavaScript
        wp_localize_script('explore-premium-scripts', 'exploreConfig', array(
            'ajaxurl' => admin_url('admin-ajax.php'),
            'nonce' => wp_create_nonce('explore_nonce'),
            'debug' => defined('WP_DEBUG') && WP_DEBUG
        ));
    }
}
add_action('wp_enqueue_scripts', 'enqueue_explore_premium_assets_global');

// Shortcode de secours si le syst√®me principal ne charge pas
function explore_fallback_shortcode($atts) {
    if (!class_exists('ExploreSystemPremium')) {
        return '<div style="padding: 40px; text-align: center; background: #f8f9fa; border-radius: 12px; margin: 20px 0;">
                    <h3 style="color: #c59d3a; margin-bottom: 10px;">üéπ Explore System</h3>
                    <p style="color: #666; margin: 0;">Please ensure the Explore page files are properly uploaded to your theme.</p>
                </div>';
    }
    
    return '';
}
add_shortcode('explore_system_check', 'explore_fallback_shortcode');




/**
 * Fonction page about & contact us
 */

require_once get_stylesheet_directory() . '/assets/Other Page/Pianomode/include-about-contact.php';


/**
 * ===================================================
 * PIANOMODE PRICE CTA - VERSION S√âCURIS√âE
 * ===================================================
 */

// V√©rification s√©curis√©e de l'existence du fichier
$pianomode_price_cta_file = get_stylesheet_directory() . '/assets/CTA/pm-price-cta.php';

if (file_exists($pianomode_price_cta_file)) {
    require_once $pianomode_price_cta_file;
} else {
    // Log l'erreur en mode debug
    if (WP_DEBUG) {
        error_log('PianoMode Price CTA: Fichier pm-price-cta.php introuvable dans ' . $pianomode_price_cta_file);
    }
}

// V√©rification que la classe est bien charg√©e
add_action('init', function() {
    if (!class_exists('PianoMode_Price_CTA_System')) {
        if (WP_DEBUG) {
            error_log('PianoMode Price CTA: Classe PianoMode_Price_CTA_System non trouv√©e');
        }
    }
}, 25);



/**
 * D√âSACTIVER YOAST SEO META TAGS
 * Notre syst√®me custom est meilleur et plus adapt√© √† GEO (AI)
 */
add_action('template_redirect', function() {
    if (class_exists('WPSEO_Frontend')) {
        // D√©sactiver meta description Yoast
        add_filter('wpseo_metadesc', '__return_false');
        
        // D√©sactiver title Yoast
        add_filter('wpseo_title', '__return_false');
        
        // D√©sactiver canonical Yoast
        remove_action('wp_head', 'rel_canonical');
        add_filter('wpseo_canonical', '__return_false');
        
        // D√©sactiver Open Graph Yoast
        add_filter('wpseo_opengraph_title', '__return_false');
        add_filter('wpseo_opengraph_desc', '__return_false');
        
        // D√©sactiver Twitter Cards Yoast
        add_filter('wpseo_twitter_title', '__return_false');
        add_filter('wpseo_twitter_description', '__return_false');
    }
}, 1);

/**
 * FORCER NOS CANONICAL EN DERNIER
 */
function pianomode_force_canonical_priority() {
    remove_action('wp_head', 'pianomode_add_canonical', 1);
    add_action('wp_head', 'pianomode_add_canonical', 999); // APR√àS Yoast
}
add_action('wp', 'pianomode_force_canonical_priority');


/**
 * D√âSACTIVER RANK MATH META TAGS FRONTEND
 * On garde Rank Math pour Instant Indexing, Analytics, 404, Redirections
 * MAIS on d√©sactive tous les meta tags car notre syst√®me custom est meilleur
 * 
 * √Ä AJOUTER DANS functions.php ligne 2520 (avant related scores)
 */

// ===================================================
// D√âSACTIVER RANK MATH FRONTEND OUTPUT
// ===================================================
add_action('after_setup_theme', function() {
    
    // D√©sactiver compl√®tement le frontend de Rank Math
    add_filter('rank_math/frontend/disable', '__return_true');
    
    // D√©sactiver meta description
    add_filter('rank_math/frontend/description', '__return_false');
    
    // D√©sactiver meta title
    add_filter('rank_math/frontend/title', '__return_false');
    
    // D√©sactiver canonical
    remove_action('wp_head', 'rel_canonical');
    add_filter('rank_math/frontend/canonical', '__return_false');
    
    // D√©sactiver Open Graph
    add_filter('rank_math/opengraph/enable', '__return_false');
    add_filter('rank_math/frontend/show_keywords', '__return_false');
    
    // D√©sactiver Twitter Cards
    add_filter('rank_math/twitter/enable', '__return_false');
    
    // D√©sactiver Schema.org (on a le n√¥tre)
    add_filter('rank_math/json_ld', '__return_false', 99);
    
    // D√©sactiver breadcrumbs Rank Math (on a les n√¥tres)
    add_filter('rank_math/frontend/breadcrumb', '__return_false');
    
}, 1); // Priorit√© 1 pour √™tre ex√©cut√© tr√®s t√¥t

/**
 * FORCER NOS CANONICAL EN DERNIER
 * Au cas o√π Rank Math essaie quand m√™me d'injecter un canonical
 */
add_action('wp_head', function() {
    // Retirer tous les canonical qui auraient pu √™tre ajout√©s
    remove_action('wp_head', 'rel_canonical');
}, 1);

add_action('wp_head', function() {
    // Ajouter notre canonical en dernier
    if (is_singular()) {
        echo '<link rel="canonical" href="' . esc_url(get_permalink()) . '" />' . "\n";
    } elseif (is_category() || is_tag() || is_tax()) {
        echo '<link rel="canonical" href="' . esc_url(get_term_link(get_queried_object())) . '" />' . "\n";
    }
}, 999); // Priorit√© 999 = tr√®s tard, APR√àS Rank Math

/**
 * MESSAGE ADMIN : Confirmer que Rank Math frontend est d√©sactiv√©
 */
add_action('admin_notices', function() {
    if (current_user_can('manage_options')) {
        echo '<div class="notice notice-success is-dismissible">
            <p><strong>‚úÖ PianoMode SEO System Active</strong> - Rank Math meta tags d√©sactiv√©s. 
            Rank Math reste actif pour Instant Indexing, Analytics, 404 et Redirections.</p>
        </div>';
    }
});



// Related Scores Meta Box - META ADMIN POUR POST
require_once get_stylesheet_directory() . '/Explore page/post-meta-admin.php';



/**
 * INT√âGRATION SIGHT READING PACK_5.1 - FUNCTIONS.PHP
 * AJOUTE CE CODE DANS TON functions.php du th√®me child Blocksy
 */

 require_once get_stylesheet_directory() . '/assets/Sightreading-game/sightreading-main.php';
/**
 * ===================================================================
 * PIANOMODE SIGHT READING - INT√âGRATION COMPL√àTE
 * ===================================================================
 */

// Include the main sight reading class
//require_once get_stylesheet_directory() . '/assets/Sightreading-game/sightreading-main.php';




/**
 * PIANOMODE START JOURNEY V8.0
 * Int√©gration compl√®te avec load more et 15 tags al√©atoires
 */

function pianomode_enqueue_tonejs() {
    if (is_admin()) return;
    
    wp_enqueue_script(
        'tonejs-library',
        'https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js',
        array(),
        '14.8.49',
        true
    );
}
add_action('wp_enqueue_scripts', 'pianomode_enqueue_tonejs', 1);

function pianomode_enqueue_threejs() {
    if (is_admin()) return;
    
    wp_enqueue_script(
        'threejs-library',
        'https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js',
        array(),
        'r128',
        true
    );
    
    wp_enqueue_script(
        'threejs-orbitcontrols',
        'https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js',
        array('threejs-library'),
        'r128',
        true
    );
}
add_action('wp_enqueue_scripts', 'pianomode_enqueue_threejs', 2);

function pianomode_start_journey_shortcode($atts = array()) {
    if (is_admin()) {
        return '';
    }
    
    $atts = shortcode_atts(array(
        'show_title' => 'true',
        'show_piano' => 'true',
        'show_modules' => 'true',
        'show_masonry' => 'true',
        'enable_audio' => 'true'
    ), $atts, 'pianomode_start_journey');
    
    wp_enqueue_style(
        'pianomode-start-journey',
        get_stylesheet_directory_uri() . '/Home page/pianomode-start-journey.css',
        array(),
        '8.0.0'
    );
    
    wp_enqueue_script(
        'pianomode-start-journey',
        get_stylesheet_directory_uri() . '/Home page/pianomode-start-journey.js',
        array('tonejs-library', 'threejs-library', 'threejs-orbitcontrols'),
        '8.0.0',
        true
    );
    
    wp_localize_script('pianomode-start-journey', 'pianoModeConfig', array(
        'volume' => 0.7,
        'enableAudio' => filter_var($atts['enable_audio'], FILTER_VALIDATE_BOOLEAN),
        'ajaxUrl' => admin_url('admin-ajax.php'),
        'nonce' => wp_create_nonce('pianomode_filter_nonce'),
        'debug' => WP_DEBUG,
        'midiPath' => get_stylesheet_directory_uri() . '/Home page/midi/',
        'themeUrl' => get_stylesheet_directory_uri()
    ));
    
    $template_path = get_stylesheet_directory() . '/Home page/pianomode-start-journey.php';
    
    if (!file_exists($template_path)) {
        if (current_user_can('manage_options')) {
            return '<div style="padding:2rem;background:#ffebee;border:1px solid #f44336;border-radius:8px;color:#c62828;">
                <strong>‚ö†Ô∏è Fichier manquant :</strong> pianomode-start-journey.php
                <br><small>Chemin : ' . esc_html($template_path) . '</small>
            </div>';
        }
        return '';
    }
    
    ob_start();
    
    try {
        $show_title = filter_var($atts['show_title'], FILTER_VALIDATE_BOOLEAN);
        $show_piano = filter_var($atts['show_piano'], FILTER_VALIDATE_BOOLEAN);
        $show_modules = filter_var($atts['show_modules'], FILTER_VALIDATE_BOOLEAN);
        $show_masonry = filter_var($atts['show_masonry'], FILTER_VALIDATE_BOOLEAN);
        $enable_audio = filter_var($atts['enable_audio'], FILTER_VALIDATE_BOOLEAN);
        
        include $template_path;
        
    } catch (Exception $e) {
        ob_clean();
        if (current_user_can('manage_options') && WP_DEBUG) {
            return '<div style="padding:1rem;background:#fff3cd;border:1px solid#ffc107;">
                <strong>‚ö†Ô∏è Erreur :</strong> ' . esc_html($e->getMessage()) . '
            </div>';
        }
        return '';
    }
    
    return ob_get_clean();
}
add_shortcode('pianomode_start_journey', 'pianomode_start_journey_shortcode');

function pianomode_get_cached_masonry_posts() {
    $cache_key = 'pianomode_masonry_v8_' . get_current_blog_id();
    $cached = wp_cache_get($cache_key);
    
    if (false !== $cached) {
        return $cached;
    }
    
    $items = array();
    
    try {
        $posts_query = new WP_Query(array(
            'post_type' => 'post',
            'posts_per_page' => 6,
            'post_status' => 'publish',
            'orderby' => 'date',
            'order' => 'DESC',
            'meta_query' => array(
                array(
                    'key' => '_thumbnail_id',
                    'compare' => 'EXISTS'
                )
            ),
            'no_found_rows' => true,
            'update_post_meta_cache' => false,
            'update_post_term_cache' => true
        ));
        
        if ($posts_query->have_posts()) {
            while ($posts_query->have_posts()) {
                $posts_query->the_post();
                $items[] = get_post();
            }
            wp_reset_postdata();
        }
        
        if (post_type_exists('score')) {
            $scores_query = new WP_Query(array(
                'post_type' => 'score',
                'posts_per_page' => 3,
                'post_status' => 'publish',
                'orderby' => 'date',
                'order' => 'DESC',
                'meta_query' => array(
                    array(
                        'key' => '_thumbnail_id',
                        'compare' => 'EXISTS'
                    )
                ),
                'no_found_rows' => true,
                'update_post_meta_cache' => false,
                'update_post_term_cache' => false
            ));
            
            if ($scores_query->have_posts()) {
                while ($scores_query->have_posts()) {
                    $scores_query->the_post();
                    $items[] = get_post();
                }
                wp_reset_postdata();
            }
        }
        
        if (!empty($items)) {
            shuffle($items);
            $items = array_slice($items, 0, 9);
        }
        
        wp_cache_set($cache_key, $items, '', 3600);
        
    } catch (Exception $e) {
        if (WP_DEBUG) {
            error_log('PianoMode masonry error: ' . $e->getMessage());
        }
        $items = array();
    }
    
    return $items;
}

function pianomode_ajax_load_more() {
    check_ajax_referer('pianomode_filter_nonce', 'nonce');
    
    $page = isset($_POST['page']) ? absint($_POST['page']) : 1;
    $per_page = 9;
    $offset = ($page - 1) * $per_page;
    
    $args = array(
        'post_type' => array('post', 'score'),
        'posts_per_page' => $per_page,
        'offset' => $offset,
        'post_status' => 'publish',
        'orderby' => 'date',
        'order' => 'DESC',
        'meta_query' => array(
            array(
                'key' => '_thumbnail_id',
                'compare' => 'EXISTS'
            )
        )
    );
    
    $query = new WP_Query($args);
    
    $default_images = array(
        'fallback' => 'https://images.unsplash.com/photo-1520523839897-bd0b52f945a0?w=600&q=85&fm=webp'
    );
    
    ob_start();
    
    if ($query->have_posts()) {
        while ($query->have_posts()) {
            $query->the_post();
            $item_id = get_the_ID();
            $item_title = esc_html(get_the_title());
            $item_link = esc_url(get_permalink());
            $item_image = get_the_post_thumbnail_url($item_id, 'large');
            if (!$item_image) $item_image = $default_images['fallback'];
            $item_type = get_post_type();
            
            if ($item_type === 'score') {
                $composer = get_post_meta($item_id, '_score_composer', true);
                $item_category = $composer ?: 'Sheet Music';
                $button_text = 'Get The Music';
            } else {
                $categories = get_the_category();
                $item_category = !empty($categories) ? $categories[0]->name : 'Article';
                $button_text = 'Read More';
            }
            
            $post_tags = get_the_tags();
            $post_tag_slugs = array();
            if ($post_tags && !is_wp_error($post_tags)) {
                foreach ($post_tags as $ptag) $post_tag_slugs[] = $ptag->slug;
            }
            $post_tags_attr = !empty($post_tag_slugs) ? implode(',', $post_tag_slugs) : '';
            ?>
            <a href="<?php echo $item_link; ?>" class="pm-masonry-card" data-tags="<?php echo esc_attr($post_tags_attr); ?>">
                <div class="pm-masonry-image" style="background-image: url('<?php echo esc_url($item_image); ?>');"></div>
                <div class="pm-masonry-overlay">
                    <?php if ($item_category) : ?>
                        <span class="pm-masonry-category"><?php echo esc_html($item_category); ?></span>
                    <?php endif; ?>
                    <h3 class="pm-masonry-title"><?php echo $item_title; ?></h3>
                    <span class="pm-masonry-link">
                        <?php echo esc_html($button_text); ?>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M5 12h14M12 5l7 7-7 7"/>
                        </svg>
                    </span>
                </div>
            </a>
            <?php
        }
    }
    
    wp_reset_postdata();
    
    $html = ob_get_clean();
    
    $total_query = new WP_Query(array_merge($args, array('posts_per_page' => -1, 'fields' => 'ids', 'no_found_rows' => false)));
    $total_posts = $total_query->found_posts;
    $has_more = ($offset + $per_page) < $total_posts;
    
    wp_send_json_success(array(
        'html' => $html,
        'has_more' => $has_more,
        'total' => $total_posts,
        'loaded' => $offset + $query->post_count
    ));
}
add_action('wp_ajax_pianomode_load_more', 'pianomode_ajax_load_more');
add_action('wp_ajax_nopriv_pianomode_load_more', 'pianomode_ajax_load_more');

function pianomode_clear_cache($post_id) {
    if (wp_is_post_revision($post_id) || wp_is_post_autosave($post_id)) {
        return;
    }
    
    $cache_key = 'pianomode_masonry_v8_' . get_current_blog_id();
    wp_cache_delete($cache_key);
}
add_action('publish_post', 'pianomode_clear_cache');
add_action('publish_score', 'pianomode_clear_cache');
add_action('trash_post', 'pianomode_clear_cache');
add_action('delete_post', 'pianomode_clear_cache');

function pianomode_preload_assets() {
    if (is_admin()) return;
    
    global $post;
    if (!$post || !has_shortcode($post->post_content, 'pianomode_start_journey')) {
        return;
    }
    
    $css_url = get_stylesheet_directory_uri() . '/Home page/pianomode-start-journey.css';
    $js_url = get_stylesheet_directory_uri() . '/Home page/pianomode-start-journey.js';
    
    echo '<link rel="preload" href="' . esc_url($css_url) . '" as="style">' . "\n";
    echo '<link rel="preload" href="' . esc_url($js_url) . '" as="script">' . "\n";
    echo '<link rel="preconnect" href="https://cdnjs.cloudflare.com">' . "\n";
    echo '<link rel="preconnect" href="https://cdn.jsdelivr.net">' . "\n";
    echo '<link rel="preconnect" href="https://tonejs.github.io">' . "\n";
}
add_action('wp_head', 'pianomode_preload_assets', 1);

function pianomode_compatibility_styles() {
    if (is_admin()) return;
    
    global $post;
    if (!$post || !has_shortcode($post->post_content, 'pianomode_start_journey')) {
        return;
    }
    ?>
    <style id="pianomode-compat">
    .pm-title-section,
    .pm-piano-3d-section,
    .pm-modules-section,
    .pm-exploring-title-section,
    .pm-tags-section,
    .pm-masonry-section {
        margin-left: 0 !important;
        margin-right: 0 !important;
        padding-left: 0 !important;
        padding-right: 0 !important;
        max-width: 100% !important;
        width: 100% !important;
    }
    
    .pm-piano-3d-section *,
    .pm-modules-section *,
    .pm-masonry-section * {
        box-sizing: border-box !important;
    }
    
    @media (max-width: 768px) {
        .pm-piano-3d-section,
        .pm-modules-section,
        .pm-masonry-section {
            overflow-x: hidden !important;
        }
    }
    </style>
    <?php
}
add_action('wp_head', 'pianomode_compatibility_styles', 20);

function pianomode_create_directories() {
    $dirs = array(
        get_stylesheet_directory() . '/Home page',
        get_stylesheet_directory() . '/Home page/midi'
    );
    
    foreach ($dirs as $dir) {
        if (!file_exists($dir)) {
            wp_mkdir_p($dir);
        }
    }
}
add_action('after_switch_theme', 'pianomode_create_directories');

function pianomode_allow_midi_upload($mimes) {
    $mimes['mid'] = 'audio/midi';
    $mimes['midi'] = 'audio/midi';
    return $mimes;
}
add_filter('upload_mimes', 'pianomode_allow_midi_upload');

function pianomode_check_midi_files() {
    $midi_dir = get_stylesheet_directory() . '/Home page/midi/';
    $required_files = array(
        'bach_846.mid',
        'bohemian1.mid',
        'for_elise_by_beethoven.mid',
        'haydn_35_1.mid',
        'game_of_thrones.mid',
        'alb_se6.mid',
        'chpn_op53.mid',
        'mario_-_overworld_theme.mid'
    );
    
    $missing_files = array();
    
    foreach ($required_files as $file) {
        if (!file_exists($midi_dir . $file)) {
            $missing_files[] = $file;
        }
    }
    
    return $missing_files;
}

function pianomode_diagnostic() {
    if (!current_user_can('manage_options') || !WP_DEBUG) return;
    
    $checks = array(
        'Tone.js' => wp_script_is('tonejs-library', 'enqueued'),
        'Three.js' => wp_script_is('threejs-library', 'enqueued'),
        'OrbitControls' => wp_script_is('threejs-orbitcontrols', 'enqueued'),
        'Main CSS' => wp_style_is('pianomode-start-journey', 'enqueued'),
        'Main JS' => wp_script_is('pianomode-start-journey', 'enqueued'),
        'Template PHP' => file_exists(get_stylesheet_directory() . '/Home page/pianomode-start-journey.php'),
        'CSS File' => file_exists(get_stylesheet_directory() . '/Home page/pianomode-start-journey.css'),
        'JS File' => file_exists(get_stylesheet_directory() . '/Home page/pianomode-start-journey.js'),
        'MIDI Directory' => file_exists(get_stylesheet_directory() . '/Home page/midi/')
    );
    
    $errors = array_filter($checks, function($v) { return !$v; });
    
    if (!empty($errors)) {
        error_log('PianoMode Start Journey V8 - Checks √©chou√©s : ' . implode(', ', array_keys($errors)));
    }
    
    $missing_midi = pianomode_check_midi_files();
    if (!empty($missing_midi)) {
        error_log('PianoMode - Fichiers MIDI manquants : ' . implode(', ', $missing_midi));
    }
}
add_action('wp_footer', 'pianomode_diagnostic');

function pianomode_admin_notice_midi() {
    if (!current_user_can('manage_options')) return;
    
    $missing_midi = pianomode_check_midi_files();
    
    if (!empty($missing_midi)) {
        ?>
        <div class="notice notice-warning is-dismissible">
            <p><strong>üéπ PianoMode Start Journey V8.0</strong></p>
            <p>Les fichiers MIDI suivants sont manquants dans <code><?php echo esc_html(get_stylesheet_directory()); ?>/Home page/midi/</code> :</p>
            <ul style="list-style: disc; margin-left: 20px;">
                <?php foreach ($missing_midi as $file) : ?>
                    <li><code><?php echo esc_html($file); ?></code></li>
                <?php endforeach; ?>
            </ul>
            <p>Sans ces fichiers, les morceaux de piano ne pourront pas √™tre jou√©s automatiquement.</p>
        </div>
        <?php
    }
}
add_action('admin_notices', 'pianomode_admin_notice_midi');

function pianomode_cleanup_on_uninstall() {
    $cache_key = 'pianomode_masonry_v8_' . get_current_blog_id();
    wp_cache_delete($cache_key);
    delete_transient('pianomode_masonry_v8');
}
register_deactivation_hook(__FILE__, 'pianomode_cleanup_on_uninstall');

function pianomode_dashboard_widget() {
    wp_add_dashboard_widget(
        'pianomode_start_journey_guide',
        'üéπ PianoMode Start Journey V8.0',
        'pianomode_dashboard_widget_content'
    );
}
add_action('wp_dashboard_setup', 'pianomode_dashboard_widget');

function pianomode_dashboard_widget_content() {
    $missing_midi = pianomode_check_midi_files();
    ?>
    <div style="padding: 10px;">
        <h3>Utilisation</h3>
        <code style="background: #f1f1f1; padding: 8px; display: block; margin: 10px 0;">[pianomode_start_journey]</code>
        
        <h3>Nouveaut√©s V8.0</h3>
        <ul style="list-style: disc; margin-left: 20px;">
            <li>‚úÖ Touches blanches purement blanches</li>
            <li>‚úÖ Zoom am√©lior√© (plus proche au d√©marrage)</li>
            <li>‚úÖ Click n'importe o√π pour zoom on/off</li>
            <li>‚úÖ Free play toujours actif</li>
            <li>‚úÖ Transition douce titre-piano</li>
            <li>‚úÖ Bouton Virtual Piano stylis√©</li>
            <li>‚úÖ Select song plus haut</li>
            <li>‚úÖ Responsive mobile parfait</li>
            <li>‚úÖ 15 tags al√©atoires par page</li>
            <li>‚úÖ Bouton "See More" pour charger plus</li>
        </ul>
        
        <?php if (!empty($missing_midi)) : ?>
            <div style="background: #fff3cd; padding: 10px; border-left: 4px solid #ffc107; margin: 15px 0;">
                <strong>‚ö†Ô∏è Attention :</strong> <?php echo count($missing_midi); ?> fichiers MIDI manquants.
            </div>
        <?php else : ?>
            <div style="background: #d4edda; padding: 10px; border-left: 4px solid #28a745; margin: 15px 0;">
                <strong>‚úÖ Tous les fichiers MIDI sont pr√©sents !</strong>
            </div>
        <?php endif; ?>
        
        <h3>Fichiers requis</h3>
        <ul style="list-style: none; font-family: monospace; font-size: 0.9em;">
            <li>üìÇ /Home page/midi/</li>
            <li>&nbsp;&nbsp;&nbsp;&nbsp;‚îú‚îÄ‚îÄ üéµ bach_846.mid</li>
            <li>&nbsp;&nbsp;&nbsp;&nbsp;‚îú‚îÄ‚îÄ üéµ bohemian1.mid</li>
            <li>&nbsp;&nbsp;&nbsp;&nbsp;‚îú‚îÄ‚îÄ üéµ for_elise_by_beethoven.mid</li>
            <li>&nbsp;&nbsp;&nbsp;&nbsp;‚îú‚îÄ‚îÄ üéµ haydn_1.mid</li>
            <li>&nbsp;&nbsp;&nbsp;&nbsp;‚îú‚îÄ‚îÄ üéµ game_of_thrones.mid</li>
            <li>&nbsp;&nbsp;&nbsp;&nbsp;‚îú‚îÄ‚îÄ üéµ alb_se5_format0.mid</li>
            <li>&nbsp;&nbsp;&nbsp;&nbsp;‚îú‚îÄ‚îÄ üéµ chpn_op53.mid</li>
            <li>&nbsp;&nbsp;&nbsp;&nbsp;‚îî‚îÄ‚îÄ üéµ mario_-_overworld_theme.mid</li>
        </ul>
    </div>
    <?php
}